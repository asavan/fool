"use strict";(self.webpackChunkfool=self.webpackChunkfool||[]).push([[970],{970:(n,e,t)=>{function o(n){}t.r(e),t.d(e,{default:()=>m});let a="";const c={recv:o,open:o,socket_open:o,socket_close:o,close:o,error:o};const s=function(n){let e=n;return{init:function(n){e=n},log:function(n){e&&e.networkDebug}}}(null);function r(n,e,t){const o={from:a,action:n,data:e};return s.log("Sending ["+a+"] "+JSON.stringify(e)),t.send(JSON.stringify(o))}function i(n,e){return new Promise(((e,t)=>{const a=new WebSocket(n),i={onmessage:o,send:(n,e)=>r(n,e,a),close:()=>{c.error=o,a.close()}};return a.onopen=function(n){s.log("Websocket opened"),c.socket_open(),r("connected",{},a),e(i)},a.onclose=function(n){s.log("Websocket closed"),c.socket_close()},a.onmessage=function(n){if(n.data instanceof Blob){const e=new FileReader;e.onload=()=>{i.onmessage(e.result)},e.readAsText(n.data)}else i.onmessage(n.data)},a.onerror=function(n){c.error(function(n){const e={};for(let t in n)e[t]=n[t];return JSON.stringify(e,((n,e)=>e instanceof Node?"Node":e instanceof Window?"Window":e)," ")}(n)),t(n)},i}))}const d=function(n,e,t){a=t;let o=!1,r=null;return s.init(n),{connect:async function(){const t=n.wh?n.wh:"https:"===e.protocol?null:"ws://"+e.hostname+":"+n.wsPort;if(null==t)throw"Can't determine ws address";const d=await i(t),l=new RTCPeerConnection(null);l.onicecandidate=n=>{const e={type:"candidate",candidate:null};n.candidate&&(e.candidate=n.candidate.candidate,e.sdpMid=n.candidate.sdpMid,e.sdpMLineIndex=n.candidate.sdpMLineIndex),s.log({candidate:n.candidate}),d.send("candidate",e)},l.oniceconnectionstatechange=()=>{l.iceConnectionState},r=l.createDataChannel("gamechannel"),function(n,e){n.onmessage=function(n){s.log("data get "+n.data),c.recv(n.data)},n.onopen=function(){s.log("------ DATACHANNEL OPENED ------"),o=!0,e.send("close",{}),e.close(),c.open()},n.onclose=function(){s.log("------ DC closed! ------"),o=!1},n.onerror=function(){}}(r,d);const u=await l.createOffer();await l.setLocalDescription(u),d.send("offer",{type:"offer",sdp:u.sdp}),d.onmessage=async function(n){const e=JSON.parse(n);e.from!==a&&"server"===e.from&&e.to===a&&(s.log("Websocket message received: "+n),"candidate"===e.action?(s.log("ON CANDIDATE"),e.data.candidate?await l.addIceCandidate(e.data):await l.addIceCandidate(null)):"answer"===e.action?l.setRemoteDescription(e.data):"connected"===e.action||e.action)}},sendMessage:function(n){return s.log("data send1 "+n),!!r&&(!!o&&(s.log("data send "+n),r.send(n),o))},on:function(n,e){c[n]=e}}};const l=function(n,e){return{move:e=>n.onChange(e),dealer:e=>n.setDealer(e),username:!1,start:e=>n.onStart(e),shuffle:e=>n.onShuffle(e),draw:({playerIndex:e,card:t})=>n.onDraw(e,t),changeCurrent:e=>n.onChangeCurrent(e),clearPlayer:e=>n.onClearHand(e),discard:e=>n.onDiscard(e),roundover:e=>n.onNewRound(e),gameover:e=>n.onGameOver(e),pass:!1}};var u=t(559),f=t(392);function g(n,e){const t={method:e};return t[e]=n,JSON.stringify(t)}function m(n,e,t,o){return new Promise(((a,c)=>{const s=function(n){let e="";const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let o=0;o<n;o++)e+=t.charAt(Math.floor(62*Math.random()));return e}(6),r=d(t,n.location,s),i=e.getElementsByClassName("log")[0];r.on("error",(n=>{(0,f.cM)(t,n,i)})),r.on("socket_open",(()=>{const n=e.getElementsByClassName("places")[0];n.classList.add("loading"),r.on("socket_close",(()=>{n.classList.remove("loading"),n.classList.add("flying-cards")}))})),r.on("open",(()=>{t.externalId=s;const c=(0,u.Z)();let i=!1;const d=o(n,e,t),f=l(d);r.on("recv",(async n=>{const e=JSON.parse(n),t=e[e.method],o=f[e.method];"function"==typeof o&&c.enqueue({callback:o,res:t,fName:e.method})}));for(const[n,e]of Object.entries(f))d.on(n,(e=>r.sendMessage(g(e,n))));d.onConnect(),n.requestAnimationFrame((async function e(){if(!c.isEmpty()&&!i){const{callback:n,res:e,fName:t}=c.dequeue();i=!0,await n(e),i=!1}n.requestAnimationFrame(e)})),a(d)}));try{r.connect()}catch(n){(0,f.cM)(t,n,i),c(n)}}))}},559:(n,e,t)=>{function o(){let n={},e=0,t=0;function o(){return t-e}return{enqueue:function(e){n[t]=e,t++},dequeue:function(){const t=n[e];return e++,t},peek:function(){return n[e]},length:o,isEmpty:function(){return 0===o()}}}t.d(e,{Z:()=>o})}}]);