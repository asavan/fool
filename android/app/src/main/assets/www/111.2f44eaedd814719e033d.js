"use strict";(self.webpackChunkfool=self.webpackChunkfool||[]).push([[111],{111:(e,n,a)=>{a.r(n),a.d(n,{default:()=>c});var t=a(746),o=a(345);const c=function(e,n){const a=e,c=(0,t.A)(["recv","open","error","close","socket_open","socket_close"]);let d=!1,s=null;const i=(n,a,t)=>{if(!s)return!1;if(!d)return!1;const o={from:e,to:t,action:n,data:a};return s.send(JSON.stringify(o))};return{connect:async function(t){const r=(0,o.CD)(e,t,n);r.on("close",(e=>c.call("socket_close",e))),r.on("open",(()=>{c.call("socket_open",{}),r.send("connected",{id:e},"all")})),r.on("error",(e=>{c.call("error",e)})),await r.ready();const l=new RTCPeerConnection(null);l.onicecandidate=e=>{const a={type:"candidate",candidate:null};e.candidate&&(a.candidate=e.candidate.candidate,a.sdpMid=e.candidate.sdpMid,a.sdpMLineIndex=e.candidate.sdpMLineIndex),n.log({candidate:e.candidate}),r.send("candidate",a,"server")},l.oniceconnectionstatechange=()=>{l.iceConnectionState},s=l.createDataChannel("gamechannel"+e),function(a,t){a.onmessage=function(e){n.log("data get "+e.data),c.call("recv",e.data)},a.onopen=function(){n.log("------ DATACHANNEL OPENED ------"),d=!0,t.send("close",{},"server"),t.close(),c.call("open",{id:e,sendRawTo:i})},a.onclose=function(){n.log("------ DC closed! ------"),d=!1},a.onerror=function(){}}(s,r);const f=await l.createOffer();return await l.setLocalDescription(f),r.on("message",(async function(e){e.from!==a&&"server"===e.from&&e.to===a&&(n.log("Websocket message received: ",e),"candidate"===e.action?(n.log("ON CANDIDATE"),e.data.candidate?await l.addIceCandidate(e.data):await l.addIceCandidate(null)):"answer"===e.action?l.setRemoteDescription(e.data):"connected"===e.action||e.action)})),r.send("offer",{type:"offer",sdp:f.sdp},"server")},on:function(e,n){return c.on(e,n)},registerHandler:function(e,n){c.setOnce("recv",(a=>{const t=JSON.parse(a),o=t.data,c=e[t.action];"function"==typeof c&&n.add((()=>c(o,t.from)))}))},sendRawTo:i}}}}]);