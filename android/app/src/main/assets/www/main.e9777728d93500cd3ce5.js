(()=>{"use strict";var e,t,n={42:(e,t,n)=>{function r(e,t,n){const r=e=>{t&&("object"==typeof e&&JSON&&JSON.stringify?t.innerHTML+=JSON.stringify(e)+"<br />":t.innerHTML+=e+"<br />")};return{log:(t,...a)=>{e<n.logLevel||r(t)},error:(t,...a)=>{e>=n.logLevel&&r(t)}}}n.d(t,{A:()=>r})},158:(e,t,n)=>{n.d(t,{c:()=>r});const r=e=>new Promise((t=>setTimeout(t,e)))},217:(e,t,n)=>{function r(e,t){if(!e)throw t}n.d(t,{v:()=>r})},272:(e,t,n)=>{n.d(t,{A:()=>r});const r={makeId:function(e,t){let n="";const r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let a=0;a<e;a++)n+=r.charAt(Math.floor(62*t()));return n},randomEl:function(e,t){return e[Math.floor(t()*e.length)]},randomInteger:function(e,t,n){const r=e+n()*(t-e);return Math.floor(r)}}},541:(e,t,n)=>{n.d(t,{A:()=>r});const r=function(e,t){return{move:n=>(t.log("onMove",n),e.onMove(n.playerIndex,n.card,n.currentColor)),draw:n=>(t.log("onDraw",n),e.onDraw(n.playerIndex,n.card))}}},746:(e,t,n)=>{n.d(t,{A:()=>a});var r=n(217);function a(e){const t={};for(const n of e)t[n]=[];const n=e=>{const n=t[e];return(0,r.v)(Array.isArray(n),"No key "+e),n};return{on:(e,t)=>n(e).push(t),set:(e,n)=>t[e]=n,setOnce:(e,n)=>{t[e]=[n]},call:(e,t)=>{const r=[];for(const a of n(e))"function"==typeof a&&r.push(a(t));return Promise.all(r)},reset:e=>{t[e]=[]},actionKeys:()=>Object.keys(t)}}},911:(e,t,n)=>{n.d(t,{A:()=>a});var r=n(541);const a=function(e,t){return Object.assign({},(0,r.A)(e,t),{pass:n=>(t.log("on pass",n),e.pass(n.playerIndex)),changeCurrent:()=>function(e){e.error("Should Not Happen")}(t)})}}},r={};function a(e){var t=r[e];if(void 0!==t)return t.exports;var o=r[e]={exports:{}};return n[e].call(o.exports,o,o.exports,a),o.exports}a.m=n,a.d=(e,t)=>{for(var n in t)a.o(t,n)&&!a.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},a.f={},a.e=e=>Promise.all(Object.keys(a.f).reduce(((t,n)=>(a.f[n](e,t),t)),[])),a.u=e=>e+"."+{111:"458c4c6324ae61daa4f4",126:"1689502ec685c054eb33",249:"3697eadb2671e061c4dc",251:"4ac83fd5041297d1a62d",433:"ab70fce1eef5b7148bb4",470:"0fc6f859fdd0d2b14347",501:"a572c761f52171209170",641:"0ea6b6900c3b78da69f4",659:"819b71ec81fa02e9c250",723:"2a5214527293f020818f",923:"1885f1bd0a0104dc7641",998:"7e1ebfb977e10bfd0617"}[e]+".js",a.miniCssF=e=>{},a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="suno:",a.l=(n,r,o,c)=>{if(e[n])e[n].push(r);else{var l,s;if(void 0!==o)for(var i=document.getElementsByTagName("script"),d=0;d<i.length;d++){var u=i[d];if(u.getAttribute("src")==n||u.getAttribute("data-webpack")==t+o){l=u;break}}l||(s=!0,(l=document.createElement("script")).charset="utf-8",l.timeout=120,a.nc&&l.setAttribute("nonce",a.nc),l.setAttribute("data-webpack",t+o),l.src=n),e[n]=[r];var f=(t,r)=>{l.onerror=l.onload=null,clearTimeout(g);var a=e[n];if(delete e[n],l.parentNode&&l.parentNode.removeChild(l),a&&a.forEach((e=>e(r))),t)return t(r)},g=setTimeout(f.bind(null,void 0,{type:"timeout",target:l}),12e4);l.onerror=f.bind(null,l.onerror),l.onload=f.bind(null,l.onload),s&&document.head.appendChild(l)}},a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;a.g.importScripts&&(e=a.g.location+"");var t=a.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var n=t.getElementsByTagName("script");if(n.length)for(var r=n.length-1;r>-1&&(!e||!/^http(s?):/.test(e));)e=n[r--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),a.p=e})(),(()=>{var e={792:0};a.f.j=(t,n)=>{var r=a.o(e,t)?e[t]:void 0;if(0!==r)if(r)n.push(r[2]);else{var o=new Promise(((n,a)=>r=e[t]=[n,a]));n.push(r[2]=o);var c=a.p+a.u(t),l=new Error;a.l(c,(n=>{if(a.o(e,t)&&(0!==(r=e[t])&&(e[t]=void 0),r)){var o=n&&("load"===n.type?"missing":n.type),c=n&&n.target&&n.target.src;l.message="Loading chunk "+t+" failed.\n("+o+": "+c+")",l.name="ChunkLoadError",l.type=o,l.request=c,r[1](l)}}),"chunk-"+t,t)}};var t=(t,n)=>{var r,o,[c,l,s]=n,i=0;if(c.some((t=>0!==e[t]))){for(r in l)a.o(l,r)&&(a.m[r]=l[r]);if(s)s(a)}for(t&&t(n);i<c.length;i++)o=c[i],a.o(e,o)&&e[o]&&e[o][0](),e[o]=0},n=self.webpackChunksuno=self.webpackChunksuno||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})(),(()=>{function e(e,t,n,r){const a=t.querySelector(".name-form-cont"),o=e.sessionStorage.getItem("username"),c=e=>{r&&"function"==typeof r&&r(e)};if(o)return a.replaceChildren(),void c(o);const l=t.querySelector("#nameform").content.cloneNode(!0).firstElementChild;a.replaceChildren(l);const s=t.querySelector(".nameform"),i=t.querySelector(".nameinput"),d=t.querySelector(".container");function u(t){(function(e){return!(e.length>n.maxNameLen&&(alert(`Choose shorter name! (Less than ${n.maxNameLen} characters)`),1))})(i.value)&&(t?e.sessionStorage.setItem("username",t):t="Player",c(t),s.classList.add("hidden"),d.classList.remove("hidden"),a.replaceChildren())}"net"===n.mode&&d.classList.add("hidden"),s.addEventListener("submit",(e=>{e.preventDefault(),u(i.value)}))}var t=a(42),n=a(217),r=a(158);function o(e,t,n){let r=e;function a(){return function(e,t){for(let n=e.length-1;n>0;n--){const r=Math.floor(t()*(n+1)),a=e[n];e[n]=e[r],e[r]=a}}(r,n),t(r)}return{deal:function(){return r.pop()},addCardAndShuffle:function(e){return function(e){r.push(e)}(e),a()},setDeck:function(e){r=e},checkTop:function(e){if(0===r.length)return!1;const t=r.at(-1)===e;return t},size:()=>r.length,shuffle:a,topCard:function(){if(0!==r.length)return r.at(-1)},toJson:()=>[...r]}}const c={newShuffledDeck:async function(e,t){const n=o(function(){const e=[...Array(112).keys()];return e.splice(56,1),e.splice(69,1),e.splice(82,1),e.splice(95,1),e}(),e,t);return await n.shuffle(),n},newExternalDeck:o},l=Object.freeze(["red","yellow","green","blue"]),s="black",i=Object.freeze({CHOOSE_DEALER:1,DEALING:2,ROUND:3,ROUND_OVER:4,GAME_OVER:5});function d(e){let t;if(e%14==13)return"black";switch(Math.floor(e/14)){case 0:case 4:t="red";break;case 1:case 5:t="yellow";break;case 2:case 6:t="green";break;case 3:case 7:t="blue"}return t}function u(e){switch(e%14){case 10:return"Skip";case 11:return"Reverse";case 12:return"Draw2";case 13:return Math.floor(e/14)>=4?"Draw4":"Wild";default:return"Number "+e%14}}function f(e){let t;switch(e%14){case 10:case 11:case 12:t=20;break;case 13:t=50;break;default:t=e%14}return t}function g(e,t,n){return d(e)===n||u(e)===u(t)}const p={GOOD_COLORS:l,BLACK_COLOR:s,GameStage:i,cardColor:d,cardType:u,cardScore:f,sortByTemplate:function(e,t,n){const r="asc"===t?1:-1;e.sort(((e,t)=>{const a=d(e),o=d(t);if(a===o){const n=f(e)-f(t);return 0===n?(e-t)*r:n*r}for(const e of n){if(e===a)return-1;if(e===o)return 1}return 0}))},pileHasColor:function(e,t){return null!=e.find((e=>d(e)===t))},cardToString:function(e){return d(e)+" "+u(e)},suitable:function(e,t,n,r){return"Wild"===u(e)||("Draw4"===u(e)?!r:g(e,t,n))},sameColorOrTypeNonBlack:function(e,t,n){return d(e)!==s&&g(e,t,n)},isDrawCard:function(e){return"Draw4"===u(e)||"Draw2"===u(e)},nextPlayer:function(e,t,n,r){return(r+(e+1)*n+t)%t},matchColor:function(e,t){return!!l.includes(t)&&(d(e)===t||d(e)===s)}};var y=a(746);const h=async function({players:e,logger:t,dealToPlayer:r,dealer:a,deck:o,direction:c}){let l=[...e];for(;l.length>1;){const e=l.length,s=new Array(e);let i=0;for(let d=0;d<e;d++){const u=p.nextPlayer(d,e,c,a),f=l[u].getIndex(),g=await r(o,f);(0,n.v)(void 0!==g);const y=p.cardScore(g);t.log(">> Player "+d+" draws "+p.cardToString(g)+" and gets "+y+" points"),s[u]=y,i=Math.max(i,y)}const d=[];for(let t=0;t<e;t++)s[t]===i&&d.push(l[t]);l=d}return l.length>=1?a=l[0].getIndex():t.error("No cand",l),a};function m({settings:e,rngFunc:t,applyEffects:n,delay:r},{logger:a,traceLogger:o,debugLogger:l},{playersRaw:s,dealer:i,direction:d,deckRaw:u,discardPile:f,currentPlayer:g,cardTaken:m,cardDiscarded:C,maxScore:w,gameState:v,cardOnBoard:S,currentColor:x}){const b=w,E=function(e){return(t,n)=>{if(!t)throw e.error(n),n}}(a),L=(0,y.A)(["shuffle","shuffleFake","draw","discard","discardExternal","move","clearPlayer","clearPlayerExternal","changeCurrent","changeCurrentExternal","changeDealer","gameover","roundover","pass","drawExternal","moveExternal"]);function D(e,t){return"changeCurrent"!==e||n||a.error("try to change current without effect"),L.call(e,t)}const O=e=>D("shuffle",e),k=s.map(((e,t)=>function(e,t,n){const r=t,a=[...e];let o=n||0;const c=()=>[...a];return{toJson:()=>({score:o,pile:c()}),addCard:e=>a.push(e),pile:c,isUno:()=>1===a.length,getIndex:()=>r,cleanHand:()=>{a.length=0},removeCard:e=>{const t=a.indexOf(e);return t<0||a.splice(t,1),t},updateScore:e=>{o+=e},getScore:()=>o,setScore:e=>{o=e},hasEmptyHand:()=>0===a.length,hasColor:e=>p.pileHasColor(a,e),hasCard:e=>a.includes(e)}}(e.pile,t,e.score)));let I=c.newExternalDeck(u,O,t),P=A;function A(){return x}function q(e,t,n){return p.nextPlayer(0,t,n,e)}function R(){const e=f.pop();return I.setDeck(f),f=[e],I.shuffle()}async function B(e,t,r){if(null==e||0===e.size())return void a.error("deck is empty");const o=e.deal();if(null!=o)return k[t].addCard(o),r?await D("drawExternal",{playerIndex:t,card:o}):await D("draw",{playerIndex:t,card:o}),0===e.size()&&n&&(a.log("reshuffle discard"),await R()),o;a.error("deck is empty, should never happen")}function N(){return{[Symbol.iterator](){let e=0;return{next:()=>e>=k.length?{done:!0,value:e}:{done:!1,value:k[e++]},return:()=>(a.log("Closing"),{done:!0})}}}}async function T(){S=void 0,f=[];const e=[];for(const t of k)t.cleanHand(),e.push(D("clearPlayer",t.getIndex()));await Promise.all(e)}function G(){m=0,C=0,v!==p.GameStage.ROUND_OVER&&(g=q(g,k.length,d))}async function M(e,t){E(t===g,"Effect for other player");const n=p.cardType(e);o.log("calcCardEffect",{playerIndex:t,card:e},p.cardToString(e));const r=q(t,k.length,d);if("Reverse"===n&&(d*=-1,2===k.length&&G()),"Skip"===n&&G(),"Draw2"===n){G();for(let e=0;e<2;++e)await B(I,r)}if("Draw4"===n){G();for(let e=0;e<4;++e)await B(I,r)}await F()}async function _(e){E(e*k.length<I.size(),"Not enought cards to play");for(let t=0;t<e;++t){const e=k.length;for(let t=0;t<e;t++){const n=p.nextPlayer(t,e,d,i),r=k[n].getIndex();await B(I,r)}}const t=await async function(e){let t=e.deal();for(S=t;p.cardColor(t)===p.BLACK_COLOR;)await D("discard",t),S=void 0,await e.addCardAndShuffle(t),t=e.deal(),S=t;return f.push(t),x=p.cardColor(t),l.log("dealToDiscardEnd",J()),await D("discard",t),t}(I);v=p.GameStage.ROUND,await M(t,g)}function j(){return k[g]}async function H(t,n){if(t!==g)return a.log("Wrong player",g,t),!1;if(!j().hasCard(n))return a.error("player not has card"),!1;if(v!==p.GameStage.ROUND)return a.log("start new round"),!1;if(C>0)return a.log("already moved"),!1;if("Wild"===p.cardType(n)){if(e.lastCardNoColor&&j().isUno())return x;const n=await P(t);return p.GOOD_COLORS.includes(n)?n:(a.log("Wrong color",n),!1)}if("Draw4"===p.cardType(n)){if(j().hasColor(x))return!1;if(e.lastCardNoColor&&j().isUno())return x;const n=await P(t);return p.GOOD_COLORS.includes(n)?n:(a.log("Wrong color",n),!1)}return p.cardColor(n)===x?x:p.cardType(n)===p.cardType(S)?p.cardColor(n):(a.log("Bad card",p.cardType(n),p.cardType(S),x),!1)}async function $(e,t,r){E(v===p.GameStage.ROUND,"Move on round end");const a=k[e];a.removeCard(t),S=t,f.push(t),x=r,++C,a.hasEmptyHand()&&(v=p.GameStage.ROUND_OVER),await D("move",{playerIndex:e,card:t,currentColor:x}),n&&(await M(t,e),v!==p.GameStage.ROUND_OVER&&v!==p.GameStage.GAME_OVER||await U(e,function(){let e=0;const t=N();for(const n of t)for(const t of n.pile())e+=p.cardScore(t);return e}()))}async function U(e,t){const n=k[e];E(n.hasEmptyHand(),"End on not empty hand"),E(v!==p.GameStage.ROUND,"Bad state onRoundEnd"),await T(),n.updateScore(t);const r=n.getScore();r>=b?(v=p.GameStage.GAME_OVER,await D("gameover",{playerIndex:e,score:r,diff:t})):(v=p.GameStage.ROUND_OVER,await D("roundover",{playerIndex:e,score:r,diff:t}))}async function z(e,t,n){const r=function(e,t,n){return e!==g?(a.error("Wrong player",g,e),!1):j().hasCard(t)?p.matchColor(t,n)?v!==p.GameStage.ROUND?(a.log("start new round",J()),!1):C>0?(a.log("already moved"),!1):!!p.suitable(t,S,x,j().hasColor(x))||(a.error("Bad card",p.cardType(t),p.cardType(S),x),!1):(a.error("Wrong next color",n,t,p.cardToString(t)),E(!1,"Bad color"),!1):(a.error("player not has card"),!1)}(e,t,n);return r&&await $(e,t,n),r}async function F(){return v!==p.GameStage.ROUND_OVER&&(G(),await D("changeCurrent",J()),!0)}function J(){return{currentPlayer:g,dealer:i,direction:d,currentColor:x,cardOnBoard:S,gameState:v}}return{isMyMove:e=>g===e&&v===p.GameStage.ROUND,canDraw:()=>m>0,getCurrentSuitable:()=>{const e=j(),t=e.hasColor(x);return e.pile().filter((e=>p.suitable(e,S,x,t)))},chooseDealer:async function(){v=p.GameStage.CHOOSE_DEALER,I=await c.newShuffledDeck(O,t),i=await h({players:k,logger:o,dealToPlayer:B,dealer:i,deck:I,direction:d}),await r(e.betweenRounds),await T(),g=i,v=p.GameStage.DEALING,await D("changeCurrent",J()),o.log("dealer was chosen",J())},deal:async function(){await T(),o.log("hands clean"),v=p.GameStage.DEALING,I=await c.newShuffledDeck(O,t),o.log("after cleanAllHands"),await _(e.cardsDeal),o.log("after dealN"),v=p.GameStage.ROUND,await D("changeCurrent",J())},getPlayerIterator:N,getPlayerByIndex:function(e){return k[e]},size:function(){return k.length},on:function(e,t){return L.on(e,t)},getDealer:function(){return i},getCurrentPlayer:function(){return g},getCardOnBoard:function(){return S},tryMove:H,moveToDiscard:async function(e,t){const n=await H(e,t);if(!1===n)return!1;const r=await z(e,t,n);return E(r,"Bad move"),r},setDeck:function(e){return null==I?I=c.newExternalDeck(e,O,t):I.setDeck(e),D("shuffleFake",e)},onDraw:async function(e,t){if(!I.checkTop(t))return a.error("Different engines"),!1;if(e!==g&&!p.isDrawCard(S)&&v!==p.GameStage.CHOOSE_DEALER&&v!==p.GameStage.DEALING)return a.error("draw not for current player",J()),!1;const n=await B(I,e,!0);return void 0===n?(a.error("onDraw bad"),!1):(o.log("onDraw",n,p.cardToString(n)),m++,!0)},onMove:async function(e,t,n){const r=await z(e,t,n);return r||a.log("Different engines"),r},onDiscard:async function(e){if(null==I||!I.checkTop(e))return void a.error("Different engines");const t=I.deal();E(t===e,"Different cards");const n=p.cardColor(e);n!==p.BLACK_COLOR?x=n:E(v!==p.GameStage.ROUND,"Black on discard in live round"),S=e,f.push(e),await D("discardExternal",e)},setCurrentObj:function(e){return m=0,C=0,E(void 0!==e.dealer,"No dealer"),E(void 0!==e.currentPlayer,"No currentPlayer"),E(e.direction,"No direction"),E(void 0!==e.gameState,"No gameState"),i=e.dealer,g=e.currentPlayer,d=e.direction,v=e.gameState,D("changeCurrentExternal",{})},cleanHandExternal:function(e){return S=void 0,f=[],k[e].cleanHand(),D("clearPlayerExternal",e)},nextDealer:function(){return E(v!==p.GameStage.DEALING,"Second dealer change"),d=1,i=q(i,k.length,d),g=i,v=p.GameStage.DEALING,D("changeCurrent",J())},onDrawPlayer:async function(e){if(e!==g)return a.log("draw not for current player",e,g),!1;if(v!==p.GameStage.ROUND)return a.log("onDrawPlayer bad state",J()),!1;if(m>0)return a.log("alreadyDrawn"),!1;const t=await B(I,g);return void 0===t?(a.error("onDrawPlayer bad"),!1):(m++,l.log("onDrawPlayer",t),null!=t)},pass:async function(e){return e!==g?(a.log("pass not for current player",e,g),!1):v!==p.GameStage.ROUND?(a.log("pass bad state",J()),!1):0===m?(a.error("cannot pass"),!1):(n?await F():await D("pass",{playerIndex:e}),!0)},getCurrentColor:A,getDirection:function(){return d},onEndRound:function(e){e.playerIndex!==g&&a.log("End not for current Player");const t=k[e.playerIndex];if(!t.hasEmptyHand())return a.error("End when not empty"),!1;const n=t.getScore();return e.score!==n+e.diff?(a.error("Bad score"),!1):(v=p.GameStage.ROUND_OVER,U(e.playerIndex,e.diff))},deckSize:function(){return null==I?0:I.size()},secretlySeeTopCard:function(){if(null!=I)return I.topCard()},setColorChooser:e=>{P=e},toJson:()=>({playersRaw:k.map((e=>e.toJson())),deckRaw:I.toJson(),dealer:i,direction:d,discardPile:f,currentPlayer:g,gameState:v,cardTaken:m,cardDiscarded:C,maxScore:w,cardOnBoard:S,currentColor:x}),showAllCards:()=>v===p.GameStage.CHOOSE_DEALER,dealN:_}}function C(e,t,n,r){return n.setColorChooser((()=>function(e,t){return new Promise((n=>{t.inColorChoose=!0;const r=e.querySelector(".color-picker-holder");r.replaceChildren();const a=e.createElement("ul");a.classList.add("color-grid"),r.appendChild(a);for(const o of p.GOOD_COLORS){const c=e.createElement("li");c.classList.add(o),c.addEventListener("click",(e=>{e.preventDefault(),r.replaceChildren(),t.inColorChoose=!1,n(o)})),a.appendChild(c)}const o=e.createElement("li");o.classList.add("cancel-color"),o.addEventListener("click",(e=>{e.preventDefault(),r.replaceChildren(),t.inColorChoose=!1,n("black")})),a.appendChild(o)}))}(t,r))),{}}function w(e){const t=e.createElement("li");return t.classList.add("blank"),t}function v(e){return e.querySelector("#back").content.cloneNode(!0).firstElementChild}function S(e,t){return t.style.setProperty("--sprite-x",1400-e%14*100+"%"),t.style.setProperty("--sprite-y",800-100*Math.floor(e/14)+"%"),t.dataset.card=e,t}function x(e,t){return S(e,t.content.cloneNode(!0).firstElementChild)}function b(e,t,n,r){const a=e.createElement("ul"),o=e.querySelector("#card");a.classList.add("hand"),r&&r.sortByColor&&p.sortByTemplate(n,r.sortByColor,r.colorOrder);for(const e of n)a.appendChild(x(e,o));return t.appendChild(a),a}function E(e,t,n){!function(e,t,n,r,a){if(2===e||0===t)return;const o=n.querySelector("."+a);if(o){const e=o.querySelector(".direction");if(!e)return;return void(1===t?e.classList.add("mirror"):e.classList.remove("mirror"))}const c=r.createElement("span");c.classList.add(a);const l=r.createElement("div");l.classList.add("direction"),1===t&&l.classList.add("mirror"),c.appendChild(l),n.appendChild(c)}(n.size(),n.getDirection(),e,t,"big-circle")}function L({document:e,engine:t,settings:n,myIndex:r}){const a=e.querySelector(".places");let o=a.querySelector(".center-pile");o?o.replaceChildren():(o=e.createElement("div"),o.classList.add("center-pile"),a.appendChild(o));!function({document:e,parent:t,card:n,engine:r,clickAll:a,myIndex:o,settings:c}){const l=e.createElement("ul"),s=e.querySelector("#card");if(l.classList.add("hand"),null!=n){const e=x(n,s);l.appendChild(e),"card"===c.passAnchor&&(e.classList.add("clickable"),e.classList.add("js-pass"),e.addEventListener("click",(e=>{e.preventDefault();let t=o;return a&&(t=r.getCurrentPlayer()),r.pass(t)})))}else l.appendChild(w(e));if(0===r.deckSize())l.appendChild(w(e));else{const t=v(e);t.classList.add("js-draw"),c.passAnchor&&"deck"!==c.passAnchor||t.classList.add("js-pass"),t.addEventListener("click",(async e=>{e.preventDefault();let t=o;a&&(t=r.getCurrentPlayer()),await r.onDrawPlayer(t)||c.passAnchor&&"deck"!==c.passAnchor||await r.pass(t)})),l.appendChild(t)}t.appendChild(l)}({document:e,parent:o,card:t.getCardOnBoard(),engine:t,clickAll:n.clickAll,myIndex:r,settings:n})}function D(e){const t={green:"rgba(85, 170, 85, 0.4)",red:"rgba(255, 85, 85, 0.4)",yellow:"rgba(255, 170, 0, 0.4)",blue:"rgba(85, 85, 255, 0.4)"}[e];return null!=t?t:"rgba(240, 248, 255, 0.3)"}var O=a(272);const k=async function(e){const{document:t,settings:n,logger:a,length:o}={...e},c=t.querySelector(".center-pile");if(!c)return void a.log("No centerPile");const l=c.querySelector(".hand"),s=l.querySelector(".sprite-back");if(!s)return void a.log("No back card");const i=l.querySelector(".card");i&&!i.classList.contains("transparent")&&await async function({document:e,settings:t,cardEl:n,list:a}){const o=parseInt(n.dataset.card),c=e.querySelector("#flip-card").content.cloneNode(!0).firstElementChild,l=c.querySelector(".card-flip"),s=x(o,e.querySelector("#card"));s.classList.add("card-face");const i=v(e);i.classList.add("card-face","card-face-back"),l.appendChild(s),l.appendChild(i),l.classList.remove("is-flipped"),a.appendChild(c),n.classList.add("transparent"),await(0,r.c)(t.discardAnimBeforeFlip),l.classList.add("is-flipped"),await(0,r.c)(t.discardAnimAfterFlip)}(Object.assign(e,{cardEl:i,list:l}));const d=s.parentElement,u=[];for(let e=0;e<Math.min(o,n.shuffleMaxCardsShow);++e){const e=v(t);e.classList.add("absolute","above","long-animation"),d.insertBefore(e,s),u.push(e)}const f=e=>O.A.randomInteger(-e,e,Math.random),g=()=>(0,r.c)(n.shuffleSmallDelay*Math.random());await g();for(let e=0;e<n.shuffleTimes;++e){for(const e of u)e.style.setProperty("--dx",f(150)),e.style.setProperty("--dy",f(170)),e.classList.add("slide"),await g();await(0,r.c)(n.shuffleOutDelay);for(const e of u)e.classList.remove("slide"),await g();await(0,r.c)(n.shuffleInDelay)}await(0,r.c)(n.shuffleWaitDelay);for(const e of u)e.remove();L(e)};async function I({document:e,fromEl:t,animTime:n,newCount:a,logger:o}){const c=e.querySelector(".center-pile").querySelector(".hand").querySelector(".sprite-back"),l=c.parentElement,s=v(e);s.classList.add("absolute","above"),l.insertBefore(s,c);const i=t.getBoundingClientRect().x-c.getBoundingClientRect().x,d=t.getBoundingClientRect().y-c.getBoundingClientRect().y,u=[{transform:`translate(calc(${i}px + 100%), ${d}px) scale(0)`},{transform:"translate(0, 0) scale(1)"}],f={duration:n,easing:"linear",fill:"forwards"};"function"==typeof s.animate&&(o.log("flipList",i,d),s.animate(u,f),await(0,r.c)(n/2)),t.textContent=a,t.dataset.count=a,await(0,r.c)(n/2),s.remove()}async function P({playerIndex:e,document:t,animTime:n,logger:r}){const a=t.querySelector(`[data-id="${e}"] .card-count`);if(!a)return void r.log("No element count",e);let o=parseInt(a.textContent);for(r.log("clearHandOther",e,o);o>0;--o)r.log("clear one",o),await I({document:t,fromEl:a,animTime:n,newCount:o-1,logger:r})}async function A({document:e,logger:t,settings:n,showAll:a},o){if(!o)return void t.log("No elem cleanHandMeOne");let c=1;a&&(c=4);const l=n.drawMy*c,s=e.querySelector(".center-pile").querySelector(".hand"),i=parseInt(o.dataset.card),d=e.querySelector("#flip-card").content.cloneNode(!0).firstElementChild,u=d.querySelector(".card-flip"),f=x(i,e.querySelector("#card"));f.classList.add("card-face");const g=v(e);g.classList.add("card-face","card-face-back"),u.appendChild(f),u.appendChild(g),s.appendChild(d);const p=o.getBoundingClientRect().x-u.getBoundingClientRect().x,y=o.getBoundingClientRect().y-u.getBoundingClientRect().y;o.classList.add("transparent");const h=[{transform:`rotateY(0) translate(calc(${p}px + 100%), ${y}px)`},{transform:"rotateY(180deg)"}],m={duration:l,easing:"ease-in",fill:"forwards"};"function"==typeof u.animate&&(u.animate(h,m),t.log("animate cleanHandMeOne"),await(0,r.c)(l)),d.remove()}const q={clearHandOther:P,cleanHand:async function(e){const{logger:t,playerIndex:n,showAll:a,myIndex:o}=e;(n===o||a)&&(t.log("clearOpenHand",e),await async function(e){const{settings:t,document:n}=e,a=n.querySelector(`[data-id="${e.playerIndex}"] .hand`);for(const t of a.children)await A(e,t);await(0,r.c)(t.drawShow),a.replaceChildren()}(e)),t.log("before clearHandOther",e),await P(e)}};async function R({engine:e,hand:t,myIndex:n,logger:a,settings:o}){if(!e.isMyMove(n))return;const c=e.getCurrentSuitable();a.log("goodCards",c);let l=".js-draw";e.canDraw()||(l=".js-pass");const s=document.querySelector(l);0===c.length&&s&&s.classList.add("highlight-good");for(const e of t.children){const t=parseInt(e.dataset.card);c.includes(t)?e.classList.add("highlight-good"):e.classList.add("highlight-bad")}await(0,r.c)(o.highlightDelay);for(const e of t.children)e.classList.remove("highlight-good"),e.classList.remove("highlight-bad");s&&s.classList.remove("highlight-good")}let B=console;function N(e,t){return t.showAll||t.clickAll||e.showAllCards()}function T({document:e,engine:t,myIndex:r,settings:a,playersExternal:o}){e.documentElement.style.setProperty("--current-color",D(t.getCurrentColor()));const c=e.querySelector(".places");c.replaceChildren(),a.direction.includes("center")&&E(c,e,t);const l=e.createElement("ul");l.classList.add("circle-wrapper"),c.appendChild(l);const s=e.createElement("li");s.classList.add("moving-container"),l.appendChild(s);const i=360/t.size();(0,n.v)(t.size()===o.length,"engine not equal to presenter "+JSON.stringify({e:t.size(),p:o.length}));const d=t.getPlayerIterator();let u=0;const f=t.getDealer(),g=t.getCurrentPlayer();for(const n of d){if(u===r){++u;continue}const c=90+i*(u-r),s=e.createElement("li");if(s.classList.add("js-player"),N(t,a)){if(b(e,s,n.pile(),a),a.clickAll){const e=u;s.addEventListener("click",(n=>{n.preventDefault();const r=n.target.parentElement;if(r&&r.classList.contains("card")){const n=parseInt(r.dataset.card);return t.moveToDiscard(e,n)}}))}}else{const t=e.createElement("div");t.textContent=n.pile().length,t.dataset.count=n.pile().length,t.classList.add("card-count"),s.appendChild(t)}const d=e.createElement("div");d.classList.add("player-name");const p=o[u].name;d.textContent=p,s.appendChild(d);const y=n.getScore();if(y>0){const t=e.createElement("div");t.textContent=y,s.appendChild(t)}s.dataset.id=u,s.dataset.angle=c+"deg",s.style.setProperty("--angle-deg",c+"deg"),s.classList.add("circle"),g===u&&s.classList.add("current-player"),f===u&&s.classList.add("dealer"),++u,l.appendChild(s)}L({document:e,engine:t,settings:a,myIndex:r}),function({document:e,engine:t,myIndex:n,settings:r,playersExternal:a,logger:o},c){const l=t.getPlayerByIndex(n),s=e.createElement("div");s.classList.add("my-hand","js-player");const i=e.createElement("div");i.classList.add("row");const d=e.createElement("span"),u=a[n].name;d.textContent=u,d.classList.add("player-name"),i.appendChild(d);const f=l.getScore();if(f>0){const t=e.createElement("span");t.textContent=f,i.appendChild(t)}s.appendChild(i),s.dataset.id=n,t.getCurrentPlayer()===n&&s.classList.add("current-player"),t.getDealer()===n&&s.classList.add("dealer");const g=b(e,s,l.pile(),r);s.addEventListener("click",(async a=>{a.preventDefault();const c=a.target.parentElement;if(c&&c.classList.contains("card")){const a=parseInt(c.dataset.card);await t.moveToDiscard(n,a)||"aftermove"!==r.highlight||R({document:e,engine:t,hand:g,myIndex:n,logger:o,settings:r})}})),c.appendChild(s)}({document:e,engine:t,myIndex:r,settings:a,playersExternal:o,logger:B},c)}function G(e,t){return t?B.log("drawPlayers",t):B.trace("drawPlayers",t),e.settings.legacyView?(function({document:e,engine:t,myIndex:n,settings:r,playersExternal:a},o,c){e.documentElement.style.setProperty("--current-color",D(t.getCurrentColor()));const l=e.querySelector(".places");l.replaceChildren(),r.direction.includes("center")&&E(l,e,t);const s=e.createElement("ul");s.classList.add("circle-wrapper"),l.appendChild(s);const i=360/t.size(),d=t.getPlayerIterator(),u=t.getDealer(),f=t.getCurrentPlayer();o?c.log("Draw inner",o):c.log("Draw inner");let g=0;for(const t of d){const o=90+i*(g-n),c=e.createElement("li");c.classList.add("show-all");const l=e.createElement("span"),d=a[g].name;l.textContent=d,l.classList.add("player-name"),c.appendChild(l);const p=t.getScore();if(p>0){const t=e.createElement("span");t.textContent=p,c.appendChild(t)}b(e,c,t.pile(),r),c.dataset.id=g,c.dataset.angle=o+"deg",c.style.setProperty("--angle-deg",o+"deg"),c.classList.add("circle","player-hand","js-player"),u===g&&c.classList.add("dealer"),f===g&&c.classList.add("current-player"),s.appendChild(c),++g}L({document:e,engine:t,settings:r,myIndex:n}),s.addEventListener("click",(async e=>{e.preventDefault();const n=e.target.parentElement;if(n&&n.classList.contains("card")){const e=n.parentElement.parentElement,r=parseInt(n.dataset.card),a=parseInt(e.dataset.id);await t.moveToDiscard(a,r)}}))}(e,t,B),Promise.resolve()):(T(e),Promise.resolve())}async function M(e,t,n,a){const o=t.querySelector(".center-pile").querySelector(".hand"),c=t.querySelector("#flip-card").content.cloneNode(!0).firstElementChild,l=c.querySelector(".card-flip"),s=t.querySelector("#card"),i=x(n,s);i.classList.add("card-face");const d=v(t);d.classList.add("card-face","card-face-back"),l.appendChild(i),l.appendChild(d),o.appendChild(c);const u=t.querySelector(".my-hand .hand"),f=x(n,s);f.classList.add("transparent"),u.appendChild(f);const g=[{transform:"rotateY(180deg)"},{transform:`rotateY(0) translate(calc(${f.getBoundingClientRect().x-l.getBoundingClientRect().x}px + 100%), ${f.getBoundingClientRect().y-l.getBoundingClientRect().y}px)`}],p={duration:a,easing:"ease-out",fill:"forwards"};"function"==typeof l.animate&&(l.animate(g,p),await(0,r.c)(a)),c.remove(),f.classList.remove("transparent")}async function _(e,t,n,a,o,c){if(!o)return void B.error("No target");const l=t.querySelector(".center-pile").querySelector(".hand"),s=t.querySelector("#flip-card").content.cloneNode(!0).firstElementChild,i=s.querySelector(".card-flip"),d=x(n,t.querySelector("#card"));d.classList.add("card-face");const u=v(t);u.classList.add("card-face","card-face-back"),i.appendChild(d),i.appendChild(u),l.appendChild(s);const f=o.getBoundingClientRect(),g=[{transform:"rotateY(180deg)"},{transform:`rotateY(180deg) translate(calc(${-f.x+i.getBoundingClientRect().x-f.width/2}px), ${f.y-i.getBoundingClientRect().y+f.height/2}px) scale(0)`}],p={duration:a,easing:"ease-out",fill:"forwards"};"function"==typeof i.animate&&(i.animate(g,p),await(0,r.c)(a/2)),o.textContent=c,o.dataset.count=c,await(0,r.c)(a/2),s.remove()}async function j(e,t,n,a){const o=t.querySelector(".center-pile").querySelector(".hand"),c=parseInt(n.dataset.card,10),l=t.querySelector("#flip-card").content.cloneNode(!0).firstElementChild,s=l.querySelector(".card-flip"),i=x(c,t.querySelector("#card"));i.classList.add("card-face");const d=v(t);d.classList.add("card-face","card-face-back"),s.appendChild(i),s.appendChild(d),o.appendChild(l);const u=n.getBoundingClientRect().x-s.getBoundingClientRect().x,f=n.getBoundingClientRect().y-s.getBoundingClientRect().y;n.classList.add("transparent");const g=[{transform:`translate(calc(${u}px + 100%), ${f}px)`},{transform:"translate(0, 0)"}],p=[{},{width:"0%"}],y={duration:a,easing:"linear",fill:"forwards"};"function"==typeof s.animate&&(s.animate(g,y),n.animate(p,y),await(0,r.c)(a));S(c,o.querySelector(".card")),n.remove(),l.remove()}async function H(e,t,n,a,o,c){const l=t.querySelector(".center-pile").querySelector(".hand"),s=t.querySelector("#flip-card").content.cloneNode(!0).firstElementChild,i=s.querySelector(".card-flip"),d=x(o,t.querySelector("#card"));d.classList.add("card-face");const u=v(t);u.classList.add("card-face","card-face-back"),i.appendChild(d),i.appendChild(u),l.appendChild(s);const f=[{transform:`translate(calc(${n.getBoundingClientRect().x-i.getBoundingClientRect().x}px + 100%), ${n.getBoundingClientRect().y-i.getBoundingClientRect().y}px) scale(0)`},{transform:"translate(0, 0) scale(1)"}],g={duration:a,easing:"linear",fill:"forwards"};"function"==typeof i.animate&&(i.animate(f,g),await(0,r.c)(a/2)),n.textContent=c,n.dataset.count=c,await(0,r.c)(a/2);S(o,l.querySelector(".card")),s.remove()}function $(e,t,n,r){const a=t.querySelector(".my-hand .hand");return j(0,t,a.querySelector(`[data-card="${n}"]`),r)}const U={clearHandOther:q.clearHandOther,cleanHand:function(e){const t=N(e.engine,e.settings);return q.cleanHand(Object.assign(e,{showAll:t}))},drawPlayers:G,drawDiscard:async function({document:e,engine:t,myIndex:n,settings:a}){const o=e.querySelector(".center-pile").querySelector(".hand"),c=e.querySelector("#flip-card").content.cloneNode(!0).firstElementChild,l=c.querySelector(".card-flip"),s=e.querySelector("#card"),i=x(t.getCardOnBoard(),s);i.classList.add("card-face");const d=v(e);d.classList.add("card-face","card-face-back"),l.appendChild(i),l.appendChild(d),o.appendChild(c),await(0,r.c)(a.discardAnimBeforeFlip),l.classList.remove("is-flipped"),await(0,r.c)(a.discardAnimAfterFlip),L({document:e,engine:t,settings:a,myIndex:n})},drawCurrent:async function(e,t,n,a){const o=e.querySelectorAll(".js-player"),c=e.querySelector(".js-player.current-player");let l=null;c&&(l=c.getBoundingClientRect());let s=null;for(const e of o){e.classList.remove("dealer");const n=parseInt(e.dataset.id);t.getCurrentPlayer()===n&&(s=e),t.getDealer()===n&&e.classList.add("dealer")}let i=null;const d=a.changeCurrentPause,u=e.querySelector(".circle-wrapper"),f=e.querySelector(".moving-container");if(s&&l&&f){const t=u.getBoundingClientRect(),n=s.getBoundingClientRect();s.classList.add("rounded"),i=e.createElement("div"),i.classList.add("moving-current","rounded"),i.style.top=n.top-t.top+"px",i.style.left=n.left-t.left+"px",f.appendChild(i);const r=-n.x+l.x,a=-n.y+l.y;u?.classList.add("blur-container");const o=[{transform:`translate(${r}px, ${a}px) scale(${l.width}, ${l.height})`},{transform:`translate(0, 0) scale(${n.width}, ${n.height})`}],c={duration:d,easing:"ease-out",fill:"forwards"};"function"==typeof i.animate&&i.animate(o,c)}if(t.getCurrentColor()){e.documentElement.style.setProperty("--current-color",D(t.getCurrentColor()));E(e.querySelector(".places"),e,t)}await(0,r.c)(d/2);for(const e of o)e.classList.remove("current-player");s?.classList.add("current-player"),await(0,r.c)(d/2),s?.classList.remove("rounded"),u?.classList.remove("blur-container"),i?.remove(),i=null},drawDeal:M,drawPlayersDeal:function(e,{document:t,engine:n,myIndex:r,settings:a,playersExternal:o},c,l,s){if(!N(n,a)){if(s!==r){const e=t.querySelector(`[data-id="${s}"]`);let r=e.querySelector(".card-count");const o=n.getPlayerByIndex(s);if(!r){r=t.createElement("li"),r.textContent=o.pile().length,r.dataset.count=o.pile().length,r.classList.add("card-count");const n=e.querySelector(".hand");n?.appendChild(r)}return _(0,t,l,a.moveAnim,r,o.pile().length)}return M(0,t,l,a.dealAnim)}G({document:t,engine:n,myIndex:r,settings:a,playersExternal:o},c)},drawMoveOther:H,drawDealOther:_,drawMoveByCard:$,drawMove:j,drawPlayersMove:function(e,{document:t,engine:n,myIndex:r,settings:a,playersExternal:o},c,l,s){if(N(n,a))return G({document:t,engine:n,myIndex:r,settings:a,playersExternal:o},c);if(s!==r){const e=t.querySelector(`[data-id="${s}"]`).querySelector(".card-count"),r=n.getPlayerByIndex(s);return H(0,t,e,a.moveOtherAnim,l,r.pile().length)}return $(0,t,l,a.moveAnim)},drawShuffle:k,setLogger:function(e){B=e}};var z=a(911);function F(e){if(0===e.length)return;return e.reduce(((e,t)=>p.cardScore(e)>p.cardScore(t)?e:t))}function J(e){(0,n.v)(e.length>0);const t={};for(const n of e)void 0===t[p.cardColor(n)]&&(t[p.cardColor(n)]=0),t[p.cardColor(n)]+=p.cardScore(n);let r,a=-1;for(const[e,n]of Object.entries(t))a<n&&(r=e,a=n);return(0,n.v)(r,e.map(p.cardToString)),(0,n.v)(p.GOOD_COLORS.includes(r),e.map(p.cardToString)),r}const V={findBestGoodCard:function(e,t,r){(0,n.v)(e.length>0,"findBestGoodCard on empty hand");const a=function(e,t,r){return(0,n.v)(p.matchColor(t,r),"Bad color "+JSON.stringify({pile:e,cardOnBoard:t,currentColor:r})+" "+p.cardToString(t)),e.filter((e=>p.sameColorOrTypeNonBlack(e,t,r)))}(e,t,r);return a.length>0?F(a):F(function(e,t,r){(0,n.v)(p.matchColor(t,r),"Bad color "+JSON.stringify({pile:e,cardOnBoard:t,currentColor:r})+" "+p.cardToString(t));const a=p.pileHasColor(e,r);return e.filter((e=>p.suitable(e,t,r,a)))}(e,t,r))},bestColor:function(e,t,r){(0,n.v)(e.includes(t),"Card not in hand");const a=p.cardColor(t);if(p.GOOD_COLORS.includes(a))return a;if(a===p.BLACK_COLOR){const t=e.filter((e=>p.cardColor(e)!==p.BLACK_COLOR));return t.length>0?J(t):r(p.GOOD_COLORS)}(0,n.v)(!1)},mostWeightedColor:J};function W({players:e,engine:t,queue:n,logger:a,settings:o,rngEngine:c}){if(null==n)return void a.log("No queue - no bots");const l=[];let s=0;for(const t of e)t.is_bot&&l.push(s),++s;if(0===l.length)return void a.log("No bots, skipping");const i=function({engine:e,queue:t,logger:n,botIndexes:a,settings:o,rngEngine:c}){return{tryMove:l=>{if(l.gameState!==p.GameStage.ROUND)return void n.log("round not started yet");const s=e.getCurrentPlayer();if(l.currentPlayer!==s)return void n.error("best_card_bot bad player",s,l,l.currentPlayer);if(!a.includes(s))return void n.log("best_card_bot not bot",s);const i=e.getPlayerByIndex(s);if(i.hasEmptyHand())return void n.log("best_card_bot no cards",s);const d=(0,z.A)(e,n),u=e.secretlySeeTopCard(),f=e.getCardOnBoard(),g=t=>{const n=i.pile(),r=V.findBestGoodCard(n,e.getCardOnBoard(),e.getCurrentColor());let a,o,l=0;if(void 0===r)o={playerIndex:s,card:u},a=t>0?d.pass:d.draw;else{a=d.move;const e=e=>O.A.randomEl(e,c),t=V.bestColor(n,r,e);o={playerIndex:s,card:r,currentColor:t},++l}return async()=>(await a(o),l)};t.add((async()=>{await(0,r.c)(o.botMovePause),e.getCardOnBoard()===f?0===await g(0)()&&(await(0,r.c)(o.botSecondMovePause),await g(1)()):n.log("best_card_bot already changed",s)}))}}}({engine:t,queue:n,logger:a,botIndexes:l,settings:o,rngEngine:c});t.on("changeCurrent",(e=>{i.tryMove(e)}))}function K(e,t,n){let r=n&&n.state;r&&("object"==typeof r&&t.copy(r,t),e.state=()=>t.copy(t,{}))}class Y{constructor(e){null==e&&(e=+new Date);let t=4022871197;function n(e){e=String(e);for(let n=0;n<e.length;n++){t+=e.charCodeAt(n);let r=.02519603282416938*t;t=r>>>0,r-=t,r*=t,t=r>>>0,r-=t,t+=4294967296*r}return 2.3283064365386963e-10*(t>>>0)}this.c=1,this.s0=n(" "),this.s1=n(" "),this.s2=n(" "),this.s0-=n(e),this.s0<0&&(this.s0+=1),this.s1-=n(e),this.s1<0&&(this.s1+=1),this.s2-=n(e),this.s2<0&&(this.s2+=1)}next(){let{c:e,s0:t,s1:n,s2:r}=this,a=2091639*t+2.3283064365386963e-10*e;return this.s0=n,this.s1=r,this.s2=a-(this.c=0|a)}copy(e,t){return t.c=e.c,t.s0=e.s0,t.s1=e.s1,t.s2=e.s2,t}}function Q({window:e,document:a,settings:o},{playersExternal:c,myId:l,queue:s},i,d){const u=(0,t.A)(7,null,o),f=(0,t.A)(1,null,o),g=(0,t.A)(4,null,o),p=(0,t.A)(2,null,o),y=(0,t.A)(3,null,o);U.setLogger(p);const h=function(e,t){let n=new Y(e),r=()=>n.next();return r.double=()=>r()+11102230246251565e-32*(2097152*r()|0),r.int32=()=>4294967296*n.next()|0,r.quick=r,K(r,n,t),r}(o.seed),w=c.findIndex((e=>e.externalId===l));(0,n.v)(w>=0,"Not my game");const v=m({settings:o,rngFunc:h,applyEffects:o.applyEffects,delay:r.c},{logger:u,traceLogger:f,debugLogger:g},i);function S(e,t){if(t&&void 0!==t.playerIndex){const e=c[t.playerIndex];Object.assign(t,{externalId:e.externalId,myIndex:w})}return d[e](t)}function x(e){U.drawPlayers({document:a,engine:v,myIndex:w,settings:o,playersExternal:c},e)}function b(e,t){return t?o.drawShow:e===w?o.drawMy:o.drawClosed}v.on("draw",(({playerIndex:t,card:n})=>{U.drawPlayersDeal(e,{document:a,engine:v,myIndex:w,settings:o,playersExternal:c},"draw",n,t);const l=[(0,r.c)(b(t,v.showAllCards())),d.draw({playerIndex:t,card:n})];return Promise.all(l)})),v.on("drawExternal",(({playerIndex:t,card:n})=>{U.drawPlayersDeal(e,{document:a,engine:v,myIndex:w,settings:o,playersExternal:c},"drawExternal",n,t);const l=[(0,r.c)(b(t,v.showAllCards()))];return"server"===o.mode&&l.push(S("draw",{playerIndex:t,card:n})),Promise.all(l)})),v.on("changeCurrent",(e=>{const t=[U.drawCurrent(a,v,w,o)];return"net"!==o.mode&&t.push(S("changeCurrent",e)),Promise.all(t)})),v.on("changeCurrentExternal",(()=>{const e=[U.drawCurrent(a,v,w,o)];return Promise.all(e)})),v.on("pass",(e=>(e.playerIndex!==w&&u.error("Bad pass"),S("pass",e)))),v.on("move",(t=>{g.log("move",t);const n=[U.drawPlayersMove(e,{document:a,engine:v,myIndex:w,settings:o,playersExternal:c},"drawMove",t.card,t.playerIndex),(0,r.c)(o.movePause),S("move",t)];return Promise.all(n)})),v.on("discard",(async e=>{const t=U.drawDiscard({document:a,engine:v,myIndex:w,settings:o});await Promise.all([t,S("discard",e)])})),v.on("discardExternal",(e=>((0,n.v)(e===v.getCardOnBoard()),U.drawDiscard({document:a,engine:v,myIndex:w,settings:o})))),v.on("shuffle",(async e=>{g.log("new deck",e.length,...e);const t=[U.drawShuffle({document:a,settings:o,engine:v,myIndex:w,logger:p,length:e.length}),S("shuffle",e)];await Promise.all(t)})),v.on("shuffleFake",(e=>(u.log("new deck fake",e.length,e),U.drawShuffle({document:a,settings:o,engine:v,myIndex:w,logger:p,length:e.length})))),v.on("gameover",(async e=>{!function(e){x("onGameOver");const t=c[e.playerIndex].name,n=t+" wins",r="with score "+e.score;u.log(n,r),function(e,t,n){const r=e.querySelector(".overlay"),a=e.querySelector(".close"),o=e.querySelector(".install");a.addEventListener("click",(e=>{e.preventDefault(),r.classList.remove("show")}),!1),r.querySelector("h2").textContent=t,r.querySelector(".content").textContent=n,r.classList.add("show"),o.classList.remove("hidden2")}(a,n,r)}(e),await d.gameover(e)})),v.on("clearPlayer",(async e=>{const t=[d.clearPlayer(e)];t.push(U.cleanHand({playerIndex:e,myIndex:w,document:a,settings:o,engine:v,animTime:o.drawMy,logger:p})),await Promise.all(t)})),v.on("clearPlayerExternal",(()=>x("clearPlayerExternal"))),C(0,a,v,{inColorChoose:!1,inExternalMove:!1}),v.on("roundover",(async e=>{x("roundover"),"net"!==o.mode&&(await d.roundover(e),await(0,r.c)(o.betweenRounds),await v.nextDealer(),await(0,r.c)(o.beforeDeal),await v.deal())}));return W({players:c,engine:v,queue:s,logger:y,settings:o,rngEngine:h}),d.engineCreated(v),x("firstDraw"),f.log("engineCreated"),(0,r.c)(100).then((()=>{const e=a.querySelector(".places");e&&e.classList.remove("connected","loading","flying-cards")})),{start:async function(){x("start"),o.chooseDealer&&(await(0,r.c)(o.beforeChooseDealer),await v.chooseDealer()),await(0,r.c)(o.betweenRounds),await v.deal()},getEngine:()=>v}}function X(){}function Z({window:r,document:a,settings:o,myId:c}){const l=(0,t.A)(8,null,o),s=(0,t.A)(2,null,o);(0,n.v)(c,"No id");const i=Object.fromEntries(["move","username","draw","pass","changeCurrent","discard","shuffle","clearPlayer","roundover","engineCreated","gameover","start"].map((e=>[e,X])));let d,u,f=[],g=0,y=0;const h=o.maxClickToBan;let m=-1;const C=e=>{var t;m===e?++y:(m=e,y=1),y>=h&&(t=m,l.log("banPlayer "+t),f[t].banned=!0)};function w(){s.log("addBot"),++g;return S("bot "+g,"bot"+g,!0)}const v=()=>function(e,{onSeatsFinished:t,onSwap:n,onAddBot:r,onClick:a},o){const c=e.querySelector(".places");c.replaceChildren();const l=e.createElement("ul");l.classList.add("circle-wrapper"),c.appendChild(l);const s=360/o.filter((e=>!e.banned)).length;let i=90,d=null;l.addEventListener("click",(function(e){if(e.preventDefault(),e.target&&null!=e.target.dataset.id){if(a(parseInt(e.target.dataset.id)),d)return d.classList.remove("selected"),n(d.dataset.id,e.target.dataset.id),void(d=null);d=e.target,d.classList.add("selected")}}));for(let t=0;t<o.length;++t){const n=o[t];if(null==n){i+=s;continue}if(n.banned)continue;const r=e.createElement("li");r.innerText=o[t].name,r.dataset.id=t,r.dataset.angle=i+"deg",r.style.setProperty("--angle-deg",i+"deg"),r.classList.add("circle","clickable","player-name"),i+=s,l.appendChild(r)}{const n=e.createElement("button");n.textContent="Start",n.classList.add("start-button","clickable","flat-button"),n.addEventListener("click",(function(e){return e.preventDefault(),c.replaceChildren(),t()})),c.appendChild(n)}{const t=e.createElement("button");t.textContent="add bot",t.classList.add("bot-button","clickable","flat-button"),t.addEventListener("click",(function(e){return e.preventDefault(),r()})),c.appendChild(t)}}(a,{onSeatsFinished:D,onSwap:b,onAddBot:w,onClick:C},f);function S(e,t,r){(0,n.v)(e,"No name"),(0,n.v)(t,"No externalId");const a=f.findIndex((e=>e.externalId===t));return-1===a?f.push({name:e,externalId:t,is_bot:!!r}):f[a].name=e,v(),!0}const x=e=>(s.log("change name"),i.username({name:e,externalId:c}));function b(e,t){const n=f[e];return f[e]=f[t],f[t]=n,v()}function E(e){return Q({window:r,document:a,settings:o},{playersExternal:f,myId:c,queue:u},e,i)}const L=()=>({players:f,seed:o.seed,engine:d.getEngine().toJson()});async function D(){(0,n.v)(f.length>0,"No players"),o.seed?l.log("settings already set",o):(l.log("settings",o),o.seed=function(e){let t="";for(const n of e)t+=n.externalId;return t}(f)),f=f.filter((e=>!e.banned&&e.name)),s.log("after filter",f),d=E(function(e,t){return{playersRaw:function(e){const t=[];for(let n=0;n<e;++n)t.push({score:0,pile:[]});return t}(t),dealer:0,direction:1,deckRaw:[],discardPile:[],currentPlayer:0,gameState:p.GameStage.CHOOSE_DEALER,cardTaken:0,cardDiscarded:0,maxScore:e.maxScore||500}}(o,f.length)),s.log("Game init"),await i.start(L()),await d.start()}return{on:function(e,t){i[e]=t},join:S,canSeeGame:e=>null!=d&&(e=>{const t=f.find((t=>t.externalId===e));return void 0!==t&&!t.banned})(e),toJson:L,setQueue:e=>{u=e},onConnect:()=>e(r,a,o,x),onStart:e=>(f=e.players,o.seed=e.seed,d=E(e.engine),d),afterAllJoined:D,disconnect:e=>{if(null!=d)return!1;l.log("disconnect",e);const t=f.length;f=f.filter((t=>t.externalId!==e));const n=f.length;return v(),t>n},addBot:w}}function ee(e){switch(e.toLowerCase().trim()){case"true":case"yes":case"1":return!0;case"false":case"no":case"0":case null:return!1;default:return Boolean(e)}}function te(e,t){e.includes("botCount")||"server"!==t.mode||(t.botCount=0)}const ne={modes:["net","ai","server","hotseat"],mode:"net",connections:["supabase","webrtc","websocket"],connection:"websocket",channelTypes:["websocket","supabase"],channelType:"websocket",wsPort:8088,loggerAnchor:".log",clNAnchor:"",sNAnchor:"",passAnchor:"",logLevel:7,cardsDeal:7,botCount:2,playerIsBot:!1,idNameInStorage:"my-id",idNameLen:6,maxClickToBan:5,maxScore:500,showAll:!1,clickAll:!1,show:!0,applyEffects:!0,lastCardNoColor:!0,legacyView:!1,chooseDealer:!0,colorOrder:["red","yellow","green","blue","black"],sortByColor:"",direction:["center"],seed:"",highlight:"aftermove",highlightDelay:800,movePause:150,botMovePause:700,botSecondMovePause:300,dealAnim:500,discardAnimBeforeFlip:100,discardAnimAfterFlip:800,betweenRounds:900,beforeChooseDealer:100,drawShow:200,drawMy:120,drawClosed:50,beforeDeal:100,shufflePause:300,changeCurrentPause:500,moveAnim:250,moveOtherAnim:190,shuffleOutDelay:150,shuffleInDelay:150,shuffleWaitDelay:200,shuffleSmallDelay:10,shuffleTimes:2,shuffleMaxCardsShow:20,maxNameLen:10};function re(e){const t={...ne},n=function(e,t){const n=new URLSearchParams(e),r=[];for(const[e,a]of n)"number"==typeof t[e]?t[e]=parseInt(a,10):"boolean"==typeof t[e]?t[e]=ee(a):t[e]=a,r.push(e);return r}(e.location.search,t);return function(e,t,n){const r=["mode","wh","seed"];for(const n of r)if(e.includes(n))return void te(e,t);"https:"===n&&(t.mode="ai"),te(e,t)}(n,t,e.location.protocol),function(e,t,n){const r=["channelType"];for(const t of r)if(e.includes(t))return;"https:"===n&&(t.channelType="supabase"),te(e,t)}(n,t,e.location.protocol),t.seed||(t.seed=O.A.makeId(6,Math.random)),t}(async function(e,r){const o=re(e);let c;(function(e,t){let n=null;async function r(){try{if(!navigator||!navigator.wakeLock)return void e.log("no wake lock");n=await navigator.wakeLock.request("screen"),e.log("Awake")}catch(t){e.error("wakeLock rejected",t)}}return{lock:r,init:function(){r(),t.addEventListener("visibilitychange",(async()=>{e.log("visibilitychange",t.visibilityState),"visible"===t.visibilityState&&await r()}))},release:function(){n&&n.release().then((()=>{n=null}))}}})((0,t.A)(1,null,o),r).init(),"net"===o.mode?c=await a.e(126).then(a.bind(a,126)):"server"===o.mode?c=await a.e(998).then(a.bind(a,998)):"ai"===o.mode?c=await a.e(723).then(a.bind(a,723)):"hotseat"===o.mode?c=await a.e(659).then(a.bind(a,659)):"test"===o.mode?c=await a.e(641).then(a.bind(a,641)):(0,n.v)(!1,"Unsupported mode"),c.default(e,r,o,Z).catch((e=>{}))})(window,document)})()})();