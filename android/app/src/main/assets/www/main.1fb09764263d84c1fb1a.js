(()=>{"use strict";var e,t,r={541:(e,t,r)=>{r.d(t,{A:()=>n});const n=function(e,t){return{move:r=>(t.log("onMove",r),e.onMove(r.playerIndex,r.card,r.currentColor)),draw:r=>(t.log("onDraw",r),e.onDraw(r.playerIndex,r.card))}}},911:(e,t,r)=>{r.d(t,{A:()=>a});var n=r(541);const a=function(e,t){return Object.assign({},(0,n.A)(e,t),{pass:r=>(t.log("on pass",r),e.pass(r.playerIndex)),changeCurrent:()=>function(e){e.error("Should Not Happen")}(t)})}},217:(e,t,r)=>{function n(e,t){if(!e)throw t}r.d(t,{v:()=>n})},746:(e,t,r)=>{r.d(t,{A:()=>a});var n=r(217);function a(e){const t={};for(const r of e)t[r]=[];const r=e=>{const r=t[e];return(0,n.v)(Array.isArray(r),"No key "+e),r};return{on:(e,t)=>r(e).push(t),set:(e,r)=>t[e]=r,setOnce:(e,r)=>{t[e]=[r]},call:(e,t)=>{const n=[];for(const a of r(e))"function"==typeof a&&n.push(a(t));return Promise.allSettled(n)},reset:e=>{t[e]=[]},actionKeys:()=>Object.keys(t)}}},272:(e,t,r)=>{r.d(t,{A:()=>n});const n={makeId:function(e,t){let r="";const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let a=0;a<e;a++)r+=n.charAt(Math.floor(62*t()));return r},randomEl:function(e,t){return e[Math.floor(t()*e.length)]}}},158:(e,t,r)=>{r.d(t,{c:()=>n});const n=e=>new Promise((t=>setTimeout(t,e)))},42:(e,t,r)=>{function n(e,t,r){const n=e=>{t&&("object"==typeof e&&JSON&&JSON.stringify?t.innerHTML+=JSON.stringify(e)+"<br />":t.innerHTML+=e+"<br />")};return{log:(t,...a)=>{e<r.logLevel||n(t)},error:(t,...a)=>{e>=r.logLevel&&n(t)}}}r.d(t,{A:()=>n})},776:(e,t,r)=>{function n(e,t,r,n){const a=t.querySelector(".name-form-cont"),o=e.sessionStorage.getItem("username"),c=e=>{n&&"function"==typeof n&&n(e)};if(o)return a.replaceChildren(),void c(o);const l=t.querySelector("#nameform").content.cloneNode(!0).firstElementChild;a.replaceChildren(l);const s=t.querySelector(".nameform"),i=t.querySelector(".nameinput"),d=t.querySelector(".container");function u(t){(function(e){return!(e.length>r.maxNameLen&&(alert("Choose shorter name!"),1))})(i.value)&&(e.sessionStorage.setItem("username",t),c(t),s.classList.add("hidden"),d.classList.remove("hidden"),a.replaceChildren())}"net"===r.mode&&d.classList.add("hidden"),s.addEventListener("submit",(function(e){e.preventDefault(),u(i.value)}))}r.d(t,{A:()=>n})}},n={};function a(e){var t=n[e];if(void 0!==t)return t.exports;var o=n[e]={exports:{}};return r[e](o,o.exports,a),o.exports}a.m=r,a.d=(e,t)=>{for(var r in t)a.o(t,r)&&!a.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},a.f={},a.e=e=>Promise.all(Object.keys(a.f).reduce(((t,r)=>(a.f[r](e,t),t)),[])),a.u=e=>e+"."+{111:"2f44eaedd814719e033d",178:"5cf9c6119053c2c6fbed",249:"dd9c3868707c9caf31fb",251:"a4d212217569b851e702",433:"cb5ac00ceba351bc272d",641:"fb8ec4cf26e5bbcce0ce",659:"2b81bdf4ab40e58e3907",666:"47ee36a8ca45b800a1ec",723:"4f56e68056ae9b2f4c0d"}[e]+".js",a.miniCssF=e=>{},a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="fool:",a.l=(r,n,o,c)=>{if(e[r])e[r].push(n);else{var l,s;if(void 0!==o)for(var i=document.getElementsByTagName("script"),d=0;d<i.length;d++){var u=i[d];if(u.getAttribute("src")==r||u.getAttribute("data-webpack")==t+o){l=u;break}}l||(s=!0,(l=document.createElement("script")).charset="utf-8",l.timeout=120,a.nc&&l.setAttribute("nonce",a.nc),l.setAttribute("data-webpack",t+o),l.src=r),e[r]=[n];var f=(t,n)=>{l.onerror=l.onload=null,clearTimeout(p);var a=e[r];if(delete e[r],l.parentNode&&l.parentNode.removeChild(l),a&&a.forEach((e=>e(n))),t)return t(n)},p=setTimeout(f.bind(null,void 0,{type:"timeout",target:l}),12e4);l.onerror=f.bind(null,l.onerror),l.onload=f.bind(null,l.onload),s&&document.head.appendChild(l)}},a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;a.g.importScripts&&(e=a.g.location+"");var t=a.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var r=t.getElementsByTagName("script");if(r.length)for(var n=r.length-1;n>-1&&(!e||!/^http(s?):/.test(e));)e=r[n--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),a.p=e})(),(()=>{var e={792:0};a.f.j=(t,r)=>{var n=a.o(e,t)?e[t]:void 0;if(0!==n)if(n)r.push(n[2]);else{var o=new Promise(((r,a)=>n=e[t]=[r,a]));r.push(n[2]=o);var c=a.p+a.u(t),l=new Error;a.l(c,(r=>{if(a.o(e,t)&&(0!==(n=e[t])&&(e[t]=void 0),n)){var o=r&&("load"===r.type?"missing":r.type),c=r&&r.target&&r.target.src;l.message="Loading chunk "+t+" failed.\n("+o+": "+c+")",l.name="ChunkLoadError",l.type=o,l.request=c,n[1](l)}}),"chunk-"+t,t)}};var t=(t,r)=>{var n,o,[c,l,s]=r,i=0;if(c.some((t=>0!==e[t]))){for(n in l)a.o(l,n)&&(a.m[n]=l[n]);if(s)s(a)}for(t&&t(r);i<c.length;i++)o=c[i],a.o(e,o)&&e[o]&&e[o][0](),e[o]=0},r=self.webpackChunkfool=self.webpackChunkfool||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))})(),(()=>{const e={modes:["net","ai","server","hotseat"],mode:"net",connections:["webrtc","websocket"],connection:"websocket",wsPort:8088,loggerAnchor:".log",logLevel:7,cardsDeal:7,botCount:3,playerIsBot:!1,idNameInStorage:"my-id",idNameLen:6,maxScore:500,showAll:!1,clickAll:!1,show:!0,applyEffects:!0,colorOrder:["red","yellow","green","blue","black"],sortByColor:"",direction:["center"],seed:"",dealAnim:500,moveAnim:250,maxNameLen:15};var t=a(776);var r=a(42),n=a(217),o=a(158);function c(e,t,r){let n=e;function a(){return function(e,t){for(let r=e.length-1;r>0;r--){const n=Math.floor(t()*(r+1)),a=e[r];e[r]=e[n],e[n]=a}}(n,r),t(n)}return{deal:function(){return n.pop()},addCardAndShuffle:function(e){return function(e){n.push(e)}(e),a()},setDeck:function(e){n=e},checkTop:function(e){if(0===n.length)return!1;const t=n.at(-1)===e;return t},size:()=>n.length,shuffle:a,topCard:function(){if(0!==n.length)return n.at(-1)},toJson:()=>[...n]}}const l={newShuffledDeck:async function(e,t){const r=c(function(){const e=[...Array(112).keys()];return e.splice(56,1),e.splice(69,1),e.splice(82,1),e.splice(95,1),e}(),e,t);return await r.shuffle(),r},newExternalDeck:c},s=Object.freeze(["red","yellow","green","blue"]),i="black",d=Object.freeze({CHOOSE_DEALER:1,DEALING:2,ROUND:3,ROUND_OVER:4,GAME_OVER:5});function u(e){let t;if(e%14==13)return"black";switch(Math.floor(e/14)){case 0:case 4:t="red";break;case 1:case 5:t="yellow";break;case 2:case 6:t="green";break;case 3:case 7:t="blue"}return t}function f(e){switch(e%14){case 10:return"Skip";case 11:return"Reverse";case 12:return"Draw2";case 13:return Math.floor(e/14)>=4?"Draw4":"Wild";default:return"Number "+e%14}}function p(e){let t;switch(e%14){case 10:case 11:case 12:t=20;break;case 13:t=50;break;default:t=e%14}return t}function g(e,t,r){return u(e)===r||f(e)===f(t)}const y={GOOD_COLORS:s,BLACK_COLOR:i,GameStage:d,cardColor:u,cardType:f,cardScore:p,sortByTemplate:function(e,t,r){const n="asc"===t?1:-1;e.sort(((e,t)=>{const a=u(e),o=u(t);if(a===o){const r=p(e)-p(t);return 0===r?(e-t)*n:r*n}for(const e of r){if(e===a)return-1;if(e===o)return 1}return 0}))},pileHasColor:function(e,t){return null!=e.find((e=>u(e)===t))},cardToString:function(e){return u(e)+" "+f(e)},suitable:function(e,t,r,n){return"Wild"===f(e)||("Draw4"===f(e)?!n:g(e,t,r))},sameColorOrTypeNonBlack:function(e,t,r){return u(e)!==i&&g(e,t,r)},isDrawCard:function(e){return"Draw4"===f(e)||"Draw2"===f(e)},matchColor:function(e,t){return!!s.includes(t)&&(u(e)===t||u(e)===i)}};function h(e,t,r){const n=t,a=[...e];let o=r||0;const c=()=>[...a];return{toJson:()=>({score:o,pile:c()}),addCard:e=>a.push(e),pile:c,getIndex:()=>n,cleanHand:()=>{a.length=0},removeCard:e=>{const t=a.indexOf(e);return t<0||a.splice(t,1),t},updateScore:e=>{o+=e},getScore:()=>o,setScore:e=>{o=e},hasEmptyHand:()=>0===a.length,hasColor:e=>y.pileHasColor(a,e),hasCard:e=>a.includes(e)}}var m=a(746);function C(e,t,r,{playersRaw:n,dealer:a,direction:o,deckRaw:c,discardPile:s,currentPlayer:i,cardTaken:d,cardDiscarded:u,maxScore:f,gameState:p,cardOnBoard:g,currentColor:C}){const w=f,S=e.applyEffects,v=function(e){return(t,r)=>{if(!t)throw e.error(r),r}}(r),E=(0,m.A)(["shuffle","shuffleFake","draw","discard","discardExternal","move","clearPlayer","clearPlayerExternal","changeCurrent","changeCurrentExternal","changeDealer","gameover","roundover","pass","drawExternal","moveExternal"]);function x(e,t){return"changeCurrent"!==e||S||r.error("try to change current without effect"),E.call(e,t)}const b=e=>x("shuffle",e),D=n.map(((e,t)=>h(e.pile,t,e.score)));let O=l.newExternalDeck(c,b,t),L=k;function k(){return C}function P(e,t,r,n){return v(t>0,"Bad usage"),v(1===r||-1===r,"Bad usage direction"),(n+(e+1)*r+t)%t}function I(e,t,r){return P(0,t,r,e)}function B(){const e=s.pop();return O.setDeck(s),s=[e],O.shuffle()}async function R(e,t,n){if(null==e||0===e.size())return void r.error("deck is empty");const a=e.deal();if(null!=a)return D[t].addCard(a),n?await x("drawExternal",{playerIndex:t,card:a}):await x("draw",{playerIndex:t,card:a}),0===e.size()&&S&&(r.log("reshuffle discard"),await B()),a;r.error("deck is empty, should never happen")}function A(){return{[Symbol.iterator](){let e=0;return{next:()=>e>=D.length?{done:!0,value:e}:{done:!1,value:D[e++]},return:()=>(r.log("Closing"),{done:!0})}}}}function q(){i=I(i,D.length,o),d=0,u=0}async function N(e,t){v(t===i);const n=y.cardType(e);if(r.log("calcCardEffect",{playerIndex:t,card:e},y.cardToString(e)),"Reverse"===n&&(o*=-1,2===D.length&&q()),"Skip"===n&&q(),"Draw2"===n){q();for(let e=0;e<2;++e)await R(O,i)}if("Draw4"===n){q();for(let e=0;e<4;++e)await R(O,i)}await U()}async function T(e){v(e*D.length<O.size(),"Not enought cards to play");for(let t=0;t<e;++t){const e=D.length;for(let t=0;t<e;t++){const r=P(t,e,o,a),n=D[r].getIndex();await R(O,n)}}i!==a&&(r.error("dealN",z()),i=a,await x("changeCurrent",z()));const t=await async function(e){let t=e.deal();for(g=t;y.cardColor(t)===y.BLACK_COLOR;)await x("discard",t),g=void 0,await e.addCardAndShuffle(t),t=e.deal(),g=t;return s.push(t),C=y.cardColor(t),r.log("dealToDiscardEnd",y.cardToString(t),t),await x("discard",t),t}(O);await N(t,i),p=y.GameStage.ROUND}function G(){return D[i]}async function _(e,t){if(e!==i)return r.log("Wrong player",i,e),!1;if(!G().hasCard(t))return r.log("player not has card"),!1;if(p!==y.GameStage.ROUND)return r.log("start new round"),!1;if(u>0)return r.log("already moved"),!1;if("Wild"===y.cardType(t)){const t=await L(e);return y.GOOD_COLORS.includes(t)?t:(r.error("Wrong color",t),!1)}if("Draw4"===y.cardType(t)){if(G().hasColor(C))return!1;const t=await L(e);return y.GOOD_COLORS.includes(t)?t:(r.error("Wrong color",t),!1)}return y.cardColor(t)===C?C:y.cardType(t)===y.cardType(g)?y.cardColor(t):(r.error("Bad card",y.cardType(t),y.cardType(g),C),!1)}function M(){let e=0;const t=A();for(const r of t)for(const t of r.pile())e+=y.cardScore(t);return e}async function j(e){const t=D[e];v(t.hasEmptyHand(),"End on not empty hand"),v(p!==y.GameStage.ROUND,"Bad state onRoundEnd");const r=M();t.updateScore(r);const n=t.getScore();n>=w?(p=y.GameStage.GAME_OVER,await x("gameover",{playerIndex:e,score:n,diff:r})):(p=y.GameStage.ROUND_OVER,await x("roundover",{playerIndex:e,score:n,diff:r}))}async function H(e,t,n){const a=function(e,t,n){return e!==i?(r.error("Wrong player",i,e),!1):G().hasCard(t)?y.matchColor(t,n)?p!==y.GameStage.ROUND?(r.log("start new round",z()),!1):u>0?(r.log("already moved"),!1):!!y.suitable(t,g,C,G().hasColor(C))||(r.error("Bad card",y.cardType(t),y.cardType(g),C),!1):(r.error("Wrong next color",n,t,y.cardToString(t)),v(!1,"Bad color"),!1):(r.error("player not has card"),!1)}(e,t,n);return a&&await async function(e,t,r){v(p===y.GameStage.ROUND,"Move on round end");const n=D[e];n.removeCard(t),g=t,s.push(t),C=r,++u,n.hasEmptyHand()&&(p=y.GameStage.ROUND_OVER),await x("move",{playerIndex:e,card:t,currentColor:C}),S&&(await N(t,i),p!==y.GameStage.ROUND_OVER&&p!==y.GameStage.GAME_OVER||await j(e))}(e,t,n),a}async function U(){return q(),await x("changeCurrent",z()),!0}function z(){return{currentPlayer:i,dealer:a,direction:o,currentColor:C,cardOnBoard:g,gameState:p}}return{chooseDealer:function(){return async function(e){p=y.GameStage.CHOOSE_DEALER,O=await l.newShuffledDeck(b,e);let t=[...D];for(;t.length>1;){const e=t.length,n=new Array(e);let c=0;for(let l=0;l<e;l++){const s=P(l,e,o,a),i=t[s].getIndex(),d=await R(O,i);v(void 0!==d);const u=y.cardScore(d);r.log(">> Player "+l+" draws "+y.cardToString(d)+" and gets "+u+" points"),n[s]=u,c=Math.max(c,u)}const l=[];for(let r=0;r<e;r++)n[r]===c&&l.push(t[r]);t=l}t.length>=1?a=t[0].getIndex():r.error("No cand",t),i=a,p=y.GameStage.DEALING,await x("changeCurrent",z()),r.log("dealer was chosen",z())}(t)},deal:async function(){p=y.GameStage.DEALING,await async function(e){g=void 0,s=[];const t=[];for(const e of D)e.cleanHand(),t.push(x("clearPlayer",e.getIndex()));await Promise.allSettled(t),O=await l.newShuffledDeck(b,e)}(t),await T(e.cardsDeal),p=y.GameStage.ROUND,await x("changeCurrent",z())},getPlayerIterator:A,getPlayerByIndex:function(e){return D[e]},addPlayer:function(){return D.push(h(D.length)),!0},size:function(){return D.length},on:function(e,t){return E.on(e,t)},getDealer:function(){return a},getCurrentPlayer:function(){return i},getCardOnBoard:function(){return g},tryMove:_,moveToDiscard:async function(e,t){const r=await _(e,t);if(!1===r)return!1;const n=await H(e,t,r);return v(n,"Bad move"),n},setDeck:function(e){return null==O?O=l.newExternalDeck(e,b,t):O.setDeck(e),x("shuffleFake",e)},onDraw:async function(e,t){if(!O.checkTop(t))return r.error("Different engines"),!1;if(e!==i&&!y.isDrawCard(g)&&p!==y.GameStage.CHOOSE_DEALER&&p!==y.GameStage.DEALING)return r.error("draw not for current player",z()),!1;const n=await R(O,e,!0);return void 0===n?(r.error("onDraw bad"),!1):(r.log("onDraw",n,y.cardToString(n)),d++,!0)},onMove:async function(e,t,n){const a=await H(e,t,n);return a||r.log("Different engines"),a},onDiscard:async function(e){if(null==O||!O.checkTop(e))return void r.error("Different engines");const t=O.deal();v(t===e,"Different cards");const n=y.cardColor(e);n!==y.BLACK_COLOR?C=n:v(p!==y.GameStage.ROUND,"Black on discard in live round"),g=e,s.push(e),await x("discardExternal",e)},setCurrentObj:function(e){return d=0,u=0,v(void 0!==e.dealer,"No dealer"),v(void 0!==e.currentPlayer,"No currentPlayer"),v(e.direction,"No direction"),v(void 0!==e.gameState,"No gameState"),a=e.dealer,i=e.currentPlayer,o=e.direction,p=e.gameState,x("changeCurrentExternal",{})},cleanHandExternal:function(e){return g=void 0,s=[],D[e].cleanHand(),x("clearPlayerExternal",e)},nextDealer:function(){return o=1,a=I(a,D.length,o),i=a,p=y.GameStage.DEALING,x("changeCurrent",z())},onDrawPlayer:async function(e){if(e!==i)return r.log("draw not for current player",e,i),!1;if(p!==y.GameStage.ROUND)return r.log("onDrawPlayer bad state",z()),!1;if(d>0)return r.log("alreadyDrawn"),!1;const t=await R(O,i);return void 0===t?(r.error("onDrawPlayer bad"),!1):(d++,r.log("onDrawPlayer",t),null!=t)},pass:async function(e){return e!==i?(r.log("pass not for current player",e,i),!1):p!==y.GameStage.ROUND?(r.log("pass bad state",z()),!1):0==d?(r.error("cannot pass"),!1):(S?await U():await x("pass",{playerIndex:e}),!0)},getCurrentColor:k,getDirection:function(){return o},onEndRound:function(e){e.playerIndex!==i&&r.log("End not for current Player");const t=D[e.playerIndex];if(!t.hasEmptyHand())return r.error("End when not empty"),!1;const n=t.getScore();return e.score!==n+e.diff?(r.error("Bad score"),!1):M()!==e.diff?(r.error("Bad diff"),!1):(p=y.GameStage.ROUND_OVER,j(e.playerIndex))},deckSize:function(){return null==O?0:O.size()},secretlySeeTopCard:function(){if(null!=O)return O.topCard()},setColorChooser:e=>{L=e},toJson:()=>({playersRaw:D.map((e=>e.toJson())),deckRaw:O.toJson(),dealer:a,direction:o,discardPile:s,currentPlayer:i,gameState:p,cardTaken:d,cardDiscarded:u,maxScore:f,cardOnBoard:g,currentColor:C}),showAllCards:()=>p===y.GameStage.CHOOSE_DEALER,dealN:T}}function w(e,t,r,n){return r.setColorChooser((()=>function(e,t){return new Promise((r=>{t.inColorChoose=!0;const n=e.querySelector(".color-picker-holder");n.replaceChildren();const a=e.createElement("ul");a.classList.add("color-grid"),n.appendChild(a);for(const o of y.GOOD_COLORS){const c=e.createElement("li");c.classList.add(o),c.addEventListener("click",(e=>{e.preventDefault(),n.replaceChildren(),t.inColorChoose=!1,r(o)})),a.appendChild(c)}const o=e.createElement("li");o.classList.add("cancel-color"),o.addEventListener("click",(e=>{e.preventDefault(),n.replaceChildren(),t.inColorChoose=!1,r("black")})),a.appendChild(o)}))}(t,n))),{}}let S=console;function v(e,t){return t.style.setProperty("--sprite-x",1400-e%14*100+"%"),t.style.setProperty("--sprite-y",800-100*Math.floor(e/14)+"%"),t.dataset.card=e,t}function E(e,t){return t.showAll||t.clickAll||e.showAllCards()}function x(e,t){return v(e,t.content.cloneNode(!0).firstElementChild)}function b(e){const t=e.createElement("li");return t.classList.add("blank"),t}function D(e){return e.querySelector("#back").content.cloneNode(!0).firstElementChild}function O(e,t,r,n,a){const o=e.createElement("ul"),c=e.querySelector("#card");o.classList.add("hand"),a&&a.sortByColor&&y.sortByTemplate(r,a.sortByColor,a.colorOrder);for(const e of r)o.appendChild(x(e,c));t.appendChild(o)}function L(e,t,r){P(r.size(),r.getDirection(),e,t,"big-circle")}function k(e,t,r,n,a){const o=e.querySelector(".places");let c=o.querySelector(".center-pile");c?c.replaceChildren():(c=e.createElement("div"),c.classList.add("center-pile"),o.appendChild(c)),function(e,t,r,n,a,o){const c=e.createElement("ul"),l=e.querySelector("#card");if(c.classList.add("hand"),null!=r?c.appendChild(x(r,l)):c.appendChild(b(e)),0===n.deckSize())c.appendChild(b(e));else{const t=D(e);t.addEventListener("click",(async e=>{e.preventDefault();let t=o;a&&(t=n.getCurrentPlayer()),await n.onDrawPlayer(t)||await n.pass(t)})),c.appendChild(t)}t.appendChild(c)}(e,c,t,r,n.clickAll,a)}function P(e,t,r,n,a,o){if(2===e||0===t)return;const c=r.querySelector("."+a);c&&c.remove();const l=n.createElement("span");l.classList.add(a);const s=n.createElement("div");s.classList.add("direction"),o&&s.classList.add(o),1===t&&s.classList.add("mirror"),l.appendChild(s),r.appendChild(l)}function I(e){const t={green:"rgba(85, 170, 85, 0.4)",red:"rgba(255, 85, 85, 0.4)",yellow:"rgba(255, 170, 0, 0.4)",blue:"rgba(85, 85, 255, 0.4)"}[e];return null!=t?t:"rgba(240, 248, 255, 0.3)"}function B({document:e,engine:t,myIndex:r,settings:n,playersExternal:a}){e.documentElement.style.setProperty("--current-color",I(t.getCurrentColor()));const o=e.querySelector(".places");o.replaceChildren(),n.direction.includes("center")&&L(o,e,t);const c=e.createElement("ul");c.classList.add("circle-wrapper"),o.appendChild(c);const l=360/t.size(),s=t.getPlayerIterator();let i=0;const d=t.getDealer(),u=t.getCurrentPlayer();for(const o of s){if(i===r){++i;continue}const s=90+l*(i-r),f=e.createElement("li");if(f.classList.add("js-player"),E(t,n))O(e,f,o.pile(),0,n);else{const t=e.createElement("div");t.textContent=o.pile().length,t.classList.add("card-count"),f.appendChild(t)}const p=e.createElement("div");p.classList.add("player-name");const g=a[i].name;p.textContent=g,f.appendChild(p);const y=o.getScore();if(y>0){const t=e.createElement("div");t.textContent=y,f.appendChild(t)}f.dataset.id=i,f.dataset.angle=s+"deg",f.style.setProperty("--angle-deg",s+"deg"),f.classList.add("circle"),u===i&&f.classList.add("current-player"),d===i&&f.classList.add("dealer"),++i,c.appendChild(f)}k(e,t.getCardOnBoard(),t,n,r),function({document:e,engine:t,myIndex:r,settings:n,playersExternal:a},o){const c=t.getPlayerByIndex(r),l=e.createElement("div");l.classList.add("my-hand","js-player");const s=e.createElement("div");s.classList.add("row");const i=e.createElement("span"),d=a[r].name;i.textContent=d,i.classList.add("player-name"),s.appendChild(i);const u=c.getScore();if(u>0){const t=e.createElement("span");t.textContent=u,s.appendChild(t)}n.direction&&n.direction.includes("hand")&&P(t.size(),t.getDirection(),s,e,"sprite-container"),l.appendChild(s),l.dataset.id=r,t.getCurrentPlayer()===r&&l.classList.add("current-player"),t.getDealer()===r&&l.classList.add("dealer"),O(e,l,c.pile(),0,n),l.addEventListener("click",(async e=>{e.preventDefault();const n=e.target.parentElement;if(n&&n.classList.contains("card")){const e=parseInt(n.dataset.card);await t.moveToDiscard(r,e)}})),o.appendChild(l)}({document:e,engine:t,myIndex:r,settings:n,playersExternal:a},o)}function R(e,t){t?S.log("drawPlayers",t):S.trace("drawPlayers",t),e.settings.clickAll?function({document:e,engine:t,myIndex:r,settings:n,playersExternal:a},o){e.documentElement.style.setProperty("--current-color",I(t.getCurrentColor()));const c=e.querySelector(".places");c.replaceChildren(),n.direction.includes("center")&&L(c,e,t);const l=e.createElement("ul");l.classList.add("circle-wrapper"),c.appendChild(l);const s=360/t.size(),i=t.getPlayerIterator(),d=t.getDealer(),u=t.getCurrentPlayer();o?S.log("Draw inner",o):S.log("Draw inner");let f=0;for(const t of i){const o=90+s*(f-r),c=e.createElement("li");c.classList.add("show-all");const i=e.createElement("span"),p=a[f].name;i.textContent=p,i.classList.add("player-name"),c.appendChild(i);const g=t.getScore();if(g>0){const t=e.createElement("span");t.textContent=g,c.appendChild(t)}O(e,c,t.pile(),0,n),c.dataset.id=f,c.dataset.angle=o+"deg",c.style.setProperty("--angle-deg",o+"deg"),c.classList.add("circle","player-hand","js-player"),d===f&&c.classList.add("dealer"),u===f&&c.classList.add("current-player"),l.appendChild(c),++f}k(e,t.getCardOnBoard(),t,n,r),l.addEventListener("click",(async e=>{e.preventDefault();const r=e.target.parentElement;if(r&&r.classList.contains("card")){const e=r.parentElement.parentElement,n=parseInt(r.dataset.card),a=parseInt(e.dataset.id);await t.moveToDiscard(a,n)}}))}(e,t):B(e)}async function A(e,t,r,n){const a=t.querySelector(".center-pile").querySelector(".hand"),c=t.querySelector("#flip-card").content.cloneNode(!0).firstElementChild,l=c.querySelector(".card-flip"),s=t.querySelector("#card"),i=x(r,s);i.classList.add("card-face");const d=D(t);d.classList.add("card-face","card-face-back"),l.appendChild(i),l.appendChild(d),a.appendChild(c);const u=t.querySelector(".my-hand .hand"),f=x(r,s);f.classList.add("transparent"),u.appendChild(f);const p=[{transform:"rotateY(180deg)"},{transform:`rotateY(0) translate(calc(${f.getBoundingClientRect().x-l.getBoundingClientRect().x}px + 100%), ${f.getBoundingClientRect().y-l.getBoundingClientRect().y}px)`}],g={duration:n,easing:"ease-out",fill:"forwards"};"function"==typeof l.animate&&(l.animate(p,g),await(0,o.c)(n)),c.remove(),f.classList.remove("transparent")}async function q(e,t,r,n,a,c){if(!a)return void S.error("No target");const l=t.querySelector(".center-pile").querySelector(".hand"),s=t.querySelector("#flip-card").content.cloneNode(!0).firstElementChild,i=s.querySelector(".card-flip"),d=x(r,t.querySelector("#card"));d.classList.add("card-face");const u=D(t);u.classList.add("card-face","card-face-back"),i.appendChild(d),i.appendChild(u),l.appendChild(s);const f=a.getBoundingClientRect(),p=[{transform:"rotateY(180deg)"},{transform:`rotateY(180deg) translate(calc(${-f.x+i.getBoundingClientRect().x-f.width/2}px), ${f.y-i.getBoundingClientRect().y+f.height/2}px) scale(0)`}],g={duration:n,easing:"ease-out",fill:"forwards"};"function"==typeof i.animate&&(i.animate(p,g),await(0,o.c)(n/2)),a.textContent=c,await(0,o.c)(n/2),s.remove()}async function N(e,t,r,n){const a=t.querySelector(".center-pile").querySelector(".hand"),c=parseInt(r.dataset.card,10),l=t.querySelector("#flip-card").content.cloneNode(!0).firstElementChild,s=l.querySelector(".card-flip"),i=x(c,t.querySelector("#card"));i.classList.add("card-face");const d=D(t);d.classList.add("card-face","card-face-back"),s.appendChild(i),s.appendChild(d),a.appendChild(l);const u=r.getBoundingClientRect().x-s.getBoundingClientRect().x,f=r.getBoundingClientRect().y-s.getBoundingClientRect().y;r.classList.add("transparent");const p=[{transform:`translate(calc(${u}px + 100%), ${f}px)`},{transform:"translate(0, 0)"}],g=[{},{width:"0%"}],y={duration:n,easing:"linear",fill:"forwards"};"function"==typeof s.animate&&(s.animate(p,y),r.animate(g,y),await(0,o.c)(n));v(c,a.querySelector(".card")),r.remove(),l.remove()}async function T(e,t,r,n,a,c){const l=t.querySelector(".center-pile").querySelector(".hand"),s=t.querySelector("#flip-card").content.cloneNode(!0).firstElementChild,i=s.querySelector(".card-flip"),d=x(a,t.querySelector("#card"));d.classList.add("card-face");const u=D(t);u.classList.add("card-face","card-face-back"),i.appendChild(d),i.appendChild(u),l.appendChild(s);const f=[{transform:`translate(calc(${r.getBoundingClientRect().x-i.getBoundingClientRect().x}px + 100%), ${r.getBoundingClientRect().y-i.getBoundingClientRect().y}px) scale(0)`},{transform:"translate(0, 0) scale(1)"}],p={duration:n,easing:"linear",fill:"forwards"};"function"==typeof i.animate&&(i.animate(f,p),await(0,o.c)(n/2)),r.textContent=c,await(0,o.c)(n/2);v(a,l.querySelector(".card")),s.remove()}function G(e,t,r,n){const a=t.querySelector(".my-hand .hand");return N(0,t,a.querySelector(`[data-card="${r}"]`),n)}const _={drawPlayers:R,drawDiscard:async function(e,t,r,n){const a=e.querySelector(".center-pile").querySelector(".hand"),c=e.querySelector("#flip-card").content.cloneNode(!0).firstElementChild,l=c.querySelector(".card-flip"),s=e.querySelector("#card"),i=x(t.getCardOnBoard(),s);i.classList.add("card-face");const d=D(e);d.classList.add("card-face","card-face-back"),l.appendChild(i),l.appendChild(d),a.appendChild(c),await(0,o.c)(200),l.classList.remove("is-flipped"),await(0,o.c)(800),k(e,t.getCardOnBoard(),t,n,r)},drawCurrent:function(e,t){const r=e.querySelectorAll(".js-player");for(const e of r){e.classList.remove("current-player","dealer");const r=parseInt(e.dataset.id);t.getCurrentPlayer()===r&&e.classList.add("current-player"),t.getDealer()===r&&e.classList.add("dealer")}if(t.getCurrentColor()){e.documentElement.style.setProperty("--current-color",I(t.getCurrentColor()));L(e.querySelector(".places"),e,t)}},drawDeal:A,drawPlayersDeal:function(e,{document:t,engine:r,myIndex:n,settings:a,playersExternal:o},c,l,s){if(!E(r,a)){if(s!==n){const e=t.querySelector(`[data-id="${s}"]`).querySelector(".card-count"),n=r.getPlayerByIndex(s);return q(0,t,l,a.moveAnim,e,n.pile().length)}return A(0,t,l,a.dealAnim)}R({document:t,engine:r,myIndex:n,settings:a,playersExternal:o},c)},drawMoveOther:T,drawDealOther:q,drawMoveByCard:G,drawMove:N,drawPlayersMove:function(e,{document:t,engine:r,myIndex:n,settings:a,playersExternal:o},c,l,s){if(E(r,a))return R({document:t,engine:r,myIndex:n,settings:a,playersExternal:o},c);if(s!==n){const e=t.querySelector(`[data-id="${s}"]`).querySelector(".card-count"),n=r.getPlayerByIndex(s);return T(0,t,e,a.moveAnim,l,n.pile().length)}return G(0,t,l,a.moveAnim)},setLogger:function(e){S=e}};var M=a(911),j=a(272);function H(e,t,r){(0,n.v)(y.matchColor(t,r),"Bad color "+JSON.stringify({pile:e,cardOnBoard:t,currentColor:r})+" "+y.cardToString(t));const a=y.pileHasColor(e,r);return e.filter((e=>y.suitable(e,t,r,a)))}function U(e){if(0===e.length)return;return e.reduce(((e,t)=>y.cardScore(e)>y.cardScore(t)?e:t))}const z={findGoodCards:H,findBestScoreCard:U,findBestGoodCard:function(e,t,r){const a=function(e,t,r){return(0,n.v)(y.matchColor(t,r),"Bad color "+JSON.stringify({pile:e,cardOnBoard:t,currentColor:r})+" "+y.cardToString(t)),e.filter((e=>y.sameColorOrTypeNonBlack(e,t,r)))}(e,t,r);return a.length>0?U(a):U(H(e,t,r))},bestColor:function(e,t,r){(0,n.v)(e.includes(t));const a=y.cardColor(t);if(y.GOOD_COLORS.includes(a))return a;if(a===y.BLACK_COLOR){const t=e.filter((e=>y.cardColor(e)!==y.BLACK_COLOR));return t.length>0?function(e){(0,n.v)(e.length>0);const t=Object.fromEntries(y.GOOD_COLORS.map((e=>[e,0])));for(const r of e)t[y.cardColor(r)]+=y.cardScore(r);let r,a=0;for(const[e,n]of Object.entries(t))a<n&&(r=e,a=n);return(0,n.v)(void 0!==r),r}(t):r(y.GOOD_COLORS)}(0,n.v)(!1)}};function J(e,t,r,n){if(null==r)return void n.log("No queue - no bots");const a=[];let c=0;for(const t of e)t.is_bot&&a.push(c),++c;0!==a.length?t.on("changeCurrent",(e=>{!function(e,t,r,n,a){if(a.gameState!==y.GameStage.ROUND)return void r.log("round not started yet");const c=e.getCurrentPlayer();if(a.currentPlayer!==c)return void r.error("best_card_bot bad player",c,a,a.currentPlayer);if(!n.includes(c))return void r.log("best_card_bot not bot",c);const l=e.getPlayerByIndex(c).pile(),s=(0,M.A)(e,r),i=t=>{const r=z.findBestGoodCard(l,e.getCardOnBoard(),e.getCurrentColor());let n,a,o=0;if(void 0===r)a={playerIndex:c,card:e.secretlySeeTopCard()},n=t>0?s.pass:s.draw;else{n=s.move;const e=e=>j.A.randomEl(e,Math.random),t=z.bestColor(l,r,e);a={playerIndex:c,card:r,currentColor:t},++o}return async()=>(await n(a),o)};t.add((async()=>{await(0,o.c)(700),0===await i(0)()&&(await(0,o.c)(300),await i(1)())}))}(t,r,n,a,e)})):n.log("No bots, skipping")}function $(e,t,r){let n=r&&r.state;n&&("object"==typeof n&&t.copy(n,t),e.state=()=>t.copy(t,{}))}class V{constructor(e){null==e&&(e=+new Date);let t=4022871197;function r(e){e=String(e);for(let r=0;r<e.length;r++){t+=e.charCodeAt(r);let n=.02519603282416938*t;t=n>>>0,n-=t,n*=t,t=n>>>0,n-=t,t+=4294967296*n}return 2.3283064365386963e-10*(t>>>0)}this.c=1,this.s0=r(" "),this.s1=r(" "),this.s2=r(" "),this.s0-=r(e),this.s0<0&&(this.s0+=1),this.s1-=r(e),this.s1<0&&(this.s1+=1),this.s2-=r(e),this.s2<0&&(this.s2+=1)}next(){let{c:e,s0:t,s1:r,s2:n}=this,a=2091639*t+2.3283064365386963e-10*e;return this.s0=r,this.s1=n,this.s2=a-(this.c=0|a)}copy(e,t){return t.c=e.c,t.s0=e.s0,t.s1=e.s1,t.s2=e.s2,t}}function W({window:e,document:t,settings:a},{playersExternal:c,myId:l,queue:s},i,d){const u=(0,r.A)(7,null,a),f=(0,r.A)(2,null,a),p=(0,r.A)(6,null,a);_.setLogger(f);const g=function(e,t){let r=new V(e),n=()=>r.next();return n.double=()=>n()+11102230246251565e-32*(2097152*n()|0),n.int32=()=>4294967296*r.next()|0,n.quick=n,$(n,r,t),n}(a.seed),y=c.findIndex((e=>e.external_id===l));(0,n.v)(y>=0,"Not my game");const h=C(a,g,u,i);function m(e,t){if(t&&void 0!==t.playerIndex){const e=c[t.playerIndex];Object.assign(t,{externalId:e.external_id,myIndex:y})}return d[e](t)}function S(e){_.drawPlayers({document:t,engine:h,myIndex:y,settings:a,playersExternal:c},e)}function v(e,t){return t?200:e===y?120:50}h.on("draw",(({playerIndex:r,card:n})=>{_.drawPlayersDeal(e,{document:t,engine:h,myIndex:y,settings:a,playersExternal:c},"draw",n,r);const l=[(0,o.c)(v(r,h.showAllCards())),d.draw({playerIndex:r,card:n})];return Promise.allSettled(l)})),h.on("drawExternal",(({playerIndex:r,card:n})=>{_.drawPlayersDeal(e,{document:t,engine:h,myIndex:y,settings:a,playersExternal:c},"drawExternal",n,r);const l=[(0,o.c)(v(r,h.showAllCards()))];return"server"===a.mode&&l.push(m("draw",{playerIndex:r,card:n})),Promise.all(l)})),h.on("changeCurrent",(e=>{_.drawCurrent(t,h,y,a);const r=[(0,o.c)(50)];return"net"!==a.mode&&r.push(m("changeCurrent",e)),Promise.allSettled(r)})),h.on("changeCurrentExternal",(()=>{_.drawCurrent(t,h,y,a);const e=[(0,o.c)(50)];return Promise.allSettled(e)})),h.on("pass",(e=>(e.playerIndex!==y&&u.error("Bad pass"),m("pass",e)))),h.on("move",(r=>{u.log("move",r),_.drawPlayersMove(e,{document:t,engine:h,myIndex:y,settings:a,playersExternal:c},"drawMove",r.card,r.playerIndex);const n=[(0,o.c)(150),m("move",r)];return Promise.allSettled(n)})),h.on("discard",(async e=>{const r=_.drawDiscard(t,h,y,a);await Promise.allSettled([r,d.discard(e)])})),h.on("discardExternal",(e=>((0,n.v)(e===h.getCardOnBoard()),_.drawDiscard(t,h,y,a)))),h.on("shuffle",(async e=>{S("shuffle"),u.log("new deck",e.length,...e),await d.shuffle(e),await(0,o.c)(300)})),h.on("shuffleFake",(async e=>{S("shuffleFake"),u.log("new deck",e.length,...e),await(0,o.c)(300)})),h.on("gameover",(async e=>{!function(e){S("onGameOver");const r=c[e.playerIndex].name,n=r+" wins",a="with score "+e.score;u.log(n,a),function(e,r){const n=t.querySelector(".overlay"),a=t.querySelector(".close"),o=t.querySelector(".install");a.addEventListener("click",(function(e){e.preventDefault(),n.classList.remove("show")}),!1),n.querySelector("h2").textContent=e,n.querySelector(".content").textContent=r,n.classList.add("show"),o.classList.remove("hidden2")}(n,a)}(e),await d.gameover(e)})),h.on("clearPlayer",(async e=>{await d.clearPlayer(e),S("clearPlayer")})),h.on("clearPlayerExternal",(()=>S("clearPlayerExternal"))),w(0,t,h,{inColorChoose:!1,inExternalMove:!1}),h.on("roundover",(async e=>{S("roundover"),"net"!==a.mode&&(await d.roundover(e),await(0,o.c)(1e3),await h.nextDealer(),await h.deal())}));return J(c,h,s,p),d.engineCreated(h),S("firstDraw"),u.log("engineCreated"),(0,o.c)(100).then((()=>{const e=t.querySelector(".places");e&&e.classList.remove("connected","loading","flying-cards")})),{start:async function(){await(0,o.c)(100),await h.chooseDealer(),await(0,o.c)(700),await h.deal()},getEngine:()=>h}}function F(){}function K({window:e,document:a,settings:o,myId:c}){const l=(0,r.A)(8,null,o),s=Object.fromEntries(["move","username","draw","pass","changeCurrent","discard","shuffle","clearPlayer","roundover","engineCreated","gameover","start"].map((e=>[e,F])));let i,d,u=[],f=0;function p(){l.log("addBot"),++f;return h("bot "+f,"bot"+f,!0)}const g=()=>function(e,t,r,n,a){const o=e.querySelector(".places");o.replaceChildren();const c=e.createElement("ul");c.classList.add("circle-wrapper"),o.appendChild(c);const l=360/a.length;let s=90,i=null;c.addEventListener("click",(function(e){if(e.preventDefault(),e.target&&null!=e.target.dataset.id){if(i)return i.classList.remove("selected"),r(i.dataset.id,e.target.dataset.id),void(i=null);i=e.target,i.classList.add("selected")}}));for(let t=0;t<a.length;++t){if(null==a[t]){s+=l;continue}const r=e.createElement("li");r.innerText=a[t].name,r.dataset.id=t,r.dataset.angle=s+"deg",r.style.setProperty("--angle-deg",s+"deg"),r.classList.add("circle","clickable"),s+=l,c.appendChild(r)}{const r=e.createElement("button");r.textContent="Start",r.classList.add("start-button","clickable"),r.addEventListener("click",(function(e){return e.preventDefault(),o.replaceChildren(),t()})),o.appendChild(r)}{const t=e.createElement("button");t.textContent="add bot",t.classList.add("bot-button","clickable"),t.addEventListener("click",(function(e){return e.preventDefault(),n()})),o.appendChild(t)}}(a,v,C,p,u);function h(e,t,r){(0,n.v)(e,"No name");const a=u.findIndex((e=>e.external_id===t));return-1===a?u.push({name:e,external_id:t,is_bot:!!r}):u[a].name=e,g(),!0}const m=e=>s.username(e,c);function C(e,t){const r=u[e];return u[e]=u[t],u[t]=r,g()}function w(t){return W({window:e,document:a,settings:o},{playersExternal:u,myId:c,queue:d},t,s)}const S=()=>({players:u,seed:o.seed,engine:i.getEngine().toJson()});async function v(){(0,n.v)(u.length>0,"No players"),o.seed?l.log("settings already set",o):(l.log("settings",o),o.seed=function(e){let t="";for(const r of e)t+=r.external_id;return t}(u)),i=w(function(e,t){return{playersRaw:function(e){const t=[];for(let r=0;r<e;++r)t.push({score:0,pile:[]});return t}(t),dealer:0,direction:1,deckRaw:[],discardPile:[],currentPlayer:0,gameState:y.GameStage.CHOOSE_DEALER,cardTaken:0,cardDiscarded:0,maxScore:e.maxScore||500}}(o,u.length)),l.log("Game init"),await s.start(S()),await i.start()}return{on:function(e,t){s[e]=t},join:h,isInPlay:()=>null!=i,toJson:S,setQueue:e=>{d=e},onConnect:()=>(0,t.A)(e,a,o,m),onStart:e=>(u=e.players,o.seed=e.seed,i=w(e.engine),i),afterAllJoined:v,disconnect:e=>{if(null!=i)return!1;l.log("disconnect",e);const t=u.length;u=u.filter((t=>t.external_id!==e));const r=u.length;return g(),t>r},addBot:p}}function Y(e){switch(e.toLowerCase().trim()){case"true":case"yes":case"1":return!0;case"false":case"no":case"0":case null:return!1;default:return Boolean(e)}}(async function(t,r){const o={...e};let c;!function(e,t){const r=new URLSearchParams(e);for(const[e,n]of r)"number"==typeof t[e]?t[e]=parseInt(n,10):"boolean"==typeof t[e]?t[e]=Y(n):t[e]=n}(t.location.search,o),"net"===o.mode?c=await a.e(666).then(a.bind(a,666)):"server"===o.mode?c=await a.e(178).then(a.bind(a,178)):"ai"===o.mode?c=await a.e(723).then(a.bind(a,723)):"hotseat"===o.mode?c=await a.e(659).then(a.bind(a,659)):"test"===o.mode?c=await a.e(641).then(a.bind(a,641)):(0,n.v)(!1,"Unsupported mode"),c.default(t,r,o,K).catch((e=>{}))})(window,document)})()})();